<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link rel="icon" type="image/png" href="app-logo.png" />
    <link rel="apple-touch-icon" href="app-logo.png" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#0f172a" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-status-bar-style" content="black-translucent" />
    <title>THE GRIND DESIGN V26.6 Stable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/id.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="exercises-library.js"></script>
    <script src="js/core.js"></script>
    <script src="js/validation.js"></script>
    <script src="js/data.js"></script>
    <script src="js/safety.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/session.js"></script>
    <script src="js/ui.js"></script>
    <style>
      body {
        background-color: #0f172a;
        color: #e2e8f0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        -webkit-tap-highlight-color: transparent;
      }

      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }

      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #10b981;
        background-color: #1e293b;
      }

      select {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2334d399%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
        background-repeat: no-repeat;
        background-position: right 0.2rem top 50%;
        background-size: 0.5rem auto;
      }

      .fade-in {
        animation: fadeIn 0.3s ease-out forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .pulse-border {
        animation: pulse-green 2s infinite;
      }

      .focus-active .exercise-card {
        display: none;
      }

      .focus-active .exercise-card.active-card {
        display: block;
      }

      .plate-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 9px;
        font-weight: bold;
        margin-right: 2px;
        color: #1e293b;
      }

      .plate-20 {
        background-color: #3b82f6;
      }

      .plate-15 {
        background-color: #eab308;
      }

      .plate-10 {
        background-color: #22c55e;
      }

      .plate-5 {
        background-color: #fca5a5;
      }

      .plate-2_5 {
        background-color: #cbd5e1;
      }

      .plate-1_25 {
        background-color: #f1f5f9;
      }

      .cardio-card {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.1),
          rgba(99, 102, 241, 0.05)
        );
        border: 2px solid #3b82f6 !important;
      }

      .cardio-card .exercise-card {
        border-color: #3b82f6;
      }

      .cardio-header {
        background: rgba(59, 130, 246, 0.15);
        border-bottom: 1px solid rgba(59, 130, 246, 0.3);
      }

      .duration-preset-btn {
        background: #1e293b;
        color: #94a3b8;
        border: 1px solid #334155;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: bold;
        transition: all 0.2s;
      }

      .duration-preset-btn.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      .duration-preset-btn:hover {
        background: #334155;
      }

      .hr-zone-valid {
        color: #10b981;
        font-weight: bold;
      }

      .hr-zone-warning {
        color: #f59e0b;
        font-weight: bold;
      }

      .hr-zone-invalid {
        color: #ef4444;
        font-weight: bold;
      }

      .quick-note-badge {
        background: #334155;
        color: #94a3b8;
        border: 1px solid #475569;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .quick-note-badge:hover,
      .quick-note-badge.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
      }

      .cardio-complete-summary {
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.3),
          rgba(99, 102, 241, 0.15)
        );
        border: 2px solid rgba(59, 130, 246, 0.6);
        padding: 20px;
        border-radius: 12px;
        animation: completePulse 0.5s ease-out;
      }

      #toast-container {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;
        pointer-events: none;
        width: 90%;
        max-width: 400px;
        display: flex;
        display: flex;
        flex-direction: column-reverse;
        gap: 8px;
      }

      .toast {
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(8px);
        border: 1px solid;
        border-radius: 12px;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        pointer-events: auto;
      }

      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }

      .toast-success {
        border-color: #10b981;
      }

      .toast-warning {
        border-color: #f59e0b;
      }

      .toast-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        font-size: 12px;
        flex-shrink: 0;
      }

      .toast-success .toast-icon {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
      }

      .toast-warning .toast-icon {
        background: rgba(245, 158, 11, 0.2);
        color: #f59e0b;
      }

      .hist-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }

      .hist-table th {
        font-size: 10px;
        color: #94a3b8;
        font-weight: bold;
        text-align: left;
        padding: 6px;
        border-bottom: 1px solid #334155;
      }

      .hist-table td {
        font-size: 11px;
        color: #e2e8f0;
        padding: 8px 6px;
        border-bottom: 1px solid #1e293b;
      }

      .hist-table tr:last-child td {
        border-bottom: none;
      }

      .tab-btn {
        position: relative;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid transparent;
      }

      .tab-btn.active {
        background-color: #10b981;
        color: #0f172a;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        border-color: #10b981;
      }

      .tab-btn.inactive {
        background-color: #1e293b;
        color: #94a3b8;
        transform: scale(1);
      }

      .tab-btn.inactive:active {
        transform: scale(0.95);
      }

      #active-tab-label {
        transition: opacity 0.3s ease;
        display: inline-block;
        min-width: 120px;
      }

      .app-header {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .app-logo {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        object-fit: cover;
      }

      .volume-counter {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.1) 0%,
          rgba(5, 150, 105, 0.05) 100%
        );
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: 12px;
        padding: 12px;
        margin: 12px 0;
        animation: slideIn 0.3s ease-out;
        position: relative;
        z-index: 10;
      }

      .completed-card-summary {
        background: linear-gradient(
          135deg,
          rgba(16, 185, 129, 0.3) 0%,
          rgba(5, 150, 105, 0.15) 100%
        ) !important;
        border: 2px solid rgba(16, 185, 129, 0.6) !important;
        padding: 20px !important;
        animation: completePulse 0.5s ease-out !important;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2) !important;
        opacity: 1 !important;
        position: relative;
        z-index: 20;
      }

      @keyframes completePulse {
        0% {
          transform: scale(1);
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }
        50% {
          transform: scale(1.03);
          box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }
        100% {
          transform: scale(1);
          box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .sets-container.sets-collapsed > div[id^="row_"] {
        display: none !important;
      }

      .sets-container.sets-collapsed > .grid.grid-cols-12.gap-1 {
        display: none !important;
      }

      .exercise-card.all-completed {
        opacity: 0.3;
        transition: opacity 0.3s;
      }

      .exercise-card.all-completed:hover {
        opacity: 0.8;
      }

      .exercise-card.all-completed .volume-counter.completed-card-summary {
        opacity: 1 !important;
        filter: brightness(1.2);
      }

      .volume-diff-up {
        color: #10b981;
        animation: bounce 0.5s ease-out;
        font-weight: bold;
      }

      .volume-diff-down {
        color: #ef4444;
        font-weight: bold;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-3px);
        }
      }
      .set-note-icon {
        cursor: pointer;
        transition: all 0.2s;
        color: #64748b;
      }

      .set-note-icon:hover {
        color: #fbbf24;
        transform: scale(1.1);
      }

      .set-note-icon.has-note {
        color: #fbbf24;
      }

      .set-note-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(10px);
        border: 1px solid #334155;
        border-radius: 16px;
        padding: 20px;
        z-index: 1000;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
      }

      .completed-sets-summary {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: 8px;
        padding: 8px 12px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .completed-sets-summary:hover {
        background: rgba(16, 185, 129, 0.15);
        border-color: rgba(16, 185, 129, 0.3);
      }

      .set-row-completed {
        opacity: 0.6;
        transition: opacity 0.3s;
      }

      .sets-collapsed .set-row-completed {
        display: none;
      }
    </style>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
  </head>

  <body class="h-screen flex flex-col overflow-hidden bg-slate-900">
    <header
      class="bg-slate-900/90 backdrop-blur-md border-b border-slate-800 p-4 flex justify-between items-center z-20 absolute top-0 w-full"
    >
      <div class="app-header">
        <img
          src="app-logo.png"
          onerror="this.style.display='none'"
          class="app-logo"
          alt="Logo"
        />
        <div>
          <h1 class="font-bold text-white text-sm tracking-wide">
            THE GRIND DESIGN
          </h1>
          <p
            class="text-[10px] text-emerald-400 uppercase tracking-wider font-bold"
          >
            V26.6 Stable
          </p>
        </div>
      </div>
      <div class="flex gap-2">
        <button
          onclick="APP.ui.openModal('library')"
          class="text-xs text-indigo-400 border border-indigo-900 bg-indigo-900/20 px-3 py-1.5 rounded hover:bg-indigo-900/50 transition"
        >
          <i class="fa-solid fa-book-bookmark mr-1"></i> Library
        </button>
        <button
          onclick="APP.ui.openModal('calendar')"
          class="text-xs text-emerald-400 border border-emerald-900 bg-emerald-900/20 px-3 py-1.5 rounded hover:bg-emerald-900/50 transition"
        >
          <i class="fa-solid fa-calendar-days"></i>
        </button>
      </div>
    </header>
    <main
      id="app-container"
      class="flex-1 overflow-y-auto no-scrollbar pt-20 pb-24 px-4"
    >
      <div id="dashboard-view" class="fade-in space-y-6">
        <div
          class="bg-slate-800/50 backdrop-blur-md rounded-3xl p-6 border border-white/5 relative overflow-hidden"
        >
          <div
            class="absolute -right-4 -bottom-4 opacity-5 pointer-events-none"
          >
            <svg
              width="150"
              height="150"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M3 12h3L9 3l6 18 3-9h3" />
            </svg>
          </div>
          <div class="relative z-10">
            <h1 class="text-3xl font-bold text-white mb-1">
              Halo, <span id="display-name" class="text-emerald-400">Dok</span>!
            </h1>
            <p class="text-slate-400 text-sm mb-6">
              Kelola Intensitas, Raih Puncak Volume.
            </p>
            <div class="grid grid-cols-2 gap-3">
              <div
                onclick="APP.ui.openModal('weight')"
                class="bg-slate-700/40 rounded-2xl p-3 flex items-center gap-3 border border-white/5 cursor-pointer active:scale-95 transition"
              >
                <div class="flex items-center gap-2"></div>
                <i class="fa-solid fa-weight-scale text-emerald-400"></i>
                <div>
                  <p
                    class="text-[10px] text-slate-400 uppercase tracking-wider"
                  >
                    Weight
                  </p>
                  <p class="text-white font-bold" id="dashboard-bw">-- kg</p>
                </div>
              </div>
              <button
                onclick="APP.ui.openModal('stats')"
                class="bg-indigo-600/20 hover:bg-indigo-600/40 transition-all rounded-2xl p-3 flex items-center gap-3 border border-indigo-500/30 active:scale-95"
              >
                <div class="flex items-center gap-2"></div>
                <i class="fa-solid fa-chart-line text-blue-400"></i>
                <div class="text-left">
                  <p
                    class="text-[10px] text-indigo-300 uppercase tracking-wider"
                  >
                    Analyze
                  </p>
                  <p class="text-indigo-100 font-bold">Stats</p>
                </div>
              </button>
              <div
                class="bg-slate-700/40 rounded-2xl p-3 flex items-center gap-3 border border-white/5"
              >
                <div class="flex items-center gap-2"></div>
                <i class="fa-solid fa-fire-flame-curved text-orange-500"></i>
                <div>
                  <p
                    class="text-[10px] text-slate-400 uppercase tracking-wider"
                  >
                    TDEE
                  </p>
                  <p class="text-white font-bold" id="dashboard-tdee">
                    -- <span class="text-[10px] font-normal">kkal</span>
                  </p>
                </div>
              </div>
              <button
                onclick="APP.ui.openModal('profile')"
                class="bg-emerald-600/20 hover:bg-emerald-600/40 transition-all rounded-2xl p-3 flex items-center gap-3 border border-emerald-500/30 active:scale-95"
              >
                <div class="flex items-center gap-2"></div>
                <i class="fa-solid fa-user-gear text-slate-400"></i>
                <div class="text-left">
                  <p
                    class="text-[10px] text-emerald-300 uppercase tracking-wider"
                  >
                    Manage
                  </p>
                  <p class="text-emerald-100 font-bold">Profile</p>
                </div>
              </button>
            </div>
          </div>
        </div>
        <div
          onclick="APP.ui.openModal('spontaneous')"
          class="bg-gradient-to-r from-indigo-900/40 to-slate-800 rounded-xl p-4 border border-indigo-500/30 cursor-pointer active:scale-95 transition shadow-lg relative overflow-hidden group"
        >
          <div
            class="absolute right-0 bottom-0 text-indigo-500/10 text-6xl -mr-4 -mb-4"
          >
            <i class="fa-solid fa-bolt"></i>
          </div>
          <div class="flex items-center gap-3">
            <div
              class="bg-indigo-500 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg shadow-indigo-500/30 group-hover:scale-110 transition"
            >
              <i class="fa-solid fa-bolt"></i>
            </div>
            <div>
              <h3 class="font-bold text-white text-sm">SPONTANEOUS MODE</h3>
              <p class="text-[10px] text-indigo-300">
                Sesi Bebas / Active Recovery (No Rotation Impact)
              </p>
            </div>
          </div>
        </div>
        <div class="flex items-center justify-between">
          <p
            class="text-xs font-bold text-slate-500 uppercase tracking-widest ml-1"
          >
            Rotasi Sesi
          </p>
          <span
            class="text-[10px] text-emerald-500 bg-emerald-500/10 px-2 py-0.5 rounded flex items-center"
            ><i class="fa-solid fa-wand-magic-sparkles mr-1"></i>
            Auto-Suggest</span
          >
        </div>
        <div id="schedule-list" class="space-y-3 pb-10"></div>
        <!-- ADD NEW SESSION BUTTON -->
        <div class="mt-4">
          <button
            onclick="APP.session.openCreator()"
            class="w-full bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 active:scale-95 transition border border-emerald-400/30"
          >
            <i class="fa-solid fa-plus-circle text-xl"></i>
            <span>BUAT SESI LATIHAN BARU</span>
          </button>

          <p class="text-[10px] text-slate-500 text-center mt-2 italic">
            Buat sesi custom atau clone dari sesi existing
          </p>
        </div>
      </div>
      <div id="workout-view" class="hidden fade-in space-y-4">
        <div class="flex justify-between items-center mb-2">
          <button
            onclick="APP.nav.switchView('dashboard')"
            class="flex items-center text-slate-400 hover:text-white text-sm group"
          >
            <div
              class="bg-slate-800 p-2 rounded-full mr-2 group-hover:bg-slate-700 transition"
            >
              <i class="fa-solid fa-arrow-left"></i>
            </div>
            Kembali
          </button>
          <div class="flex gap-2">
            <span
              id="spontaneous-badge"
              class="hidden text-[10px] bg-indigo-500 text-white px-2 py-1 rounded font-bold uppercase items-center shadow-lg shadow-indigo-500/30"
              ><i class="fa-solid fa-bolt mr-1"></i> SPONTANEOUS</span
            >
            <button
              onclick="APP.ui.toggleFocusMode()"
              id="focus-btn"
              class="text-xs bg-slate-800 text-slate-400 border border-slate-700 px-3 py-1.5 rounded-full hover:text-white transition flex items-center gap-2"
            >
              <i class="fa-solid fa-eye"></i> Focus Mode
            </button>
          </div>
        </div>
        <div
          id="warmup-box"
          class="bg-indigo-900/30 border border-indigo-500/30 rounded-xl p-4 mb-6 cursor-pointer active:scale-[0.98] transition"
        >
          <div
            class="flex justify-between items-center"
            onclick="APP.ui.toggleWarmup()"
          >
            <h3 class="text-indigo-400 font-bold text-sm">
              <i class="fa-solid fa-fire-flame-curved mr-2"></i> PROTOKOL
              PEMANASAN
            </h3>
            <i
              id="warmup-arrow"
              class="fa-solid fa-chevron-down text-indigo-400 text-xs transition-transform"
            ></i>
          </div>
          <div
            id="warmup-content"
            class="hidden text-sm text-slate-300 space-y-3 mt-3"
          >
            <p class="text-[10px] text-slate-500 italic mb-2">
              *Klik teks di bawah untuk mengedit
            </p>
            <div class="flex items-start gap-2">
              <i class="fa-solid fa-person-walking text-emerald-400 mt-1"></i>
              <div
                id="warmup-general"
                onclick="APP.data.editWarmup('general')"
                class="hover:text-white cursor-text"
              >
                Jalan Cepat 5 Menit.
              </div>
            </div>
            <div class="flex items-start gap-2">
              <i class="fa-solid fa-person-running text-emerald-400 mt-1"></i>
              <div
                id="warmup-dynamic"
                onclick="APP.data.editWarmup('dynamic')"
                class="hover:text-white cursor-text text-slate-400"
              >
                Arm Circles, Leg Swings
              </div>
            </div>
          </div>
        </div>
        <div
          class="bg-slate-700/50 border border-slate-700 rounded-xl p-3 mb-4 cursor-pointer"
          onclick="APP.ui.openModal('rpe')"
        >
          <p
            class="text-[10px] font-bold text-yellow-400 uppercase mb-2 flex justify-between"
          >
            <span
              ><i class="fa-solid fa-ranking-star mr-1"></i> Intensitas
              (RPE)</span
            >
            <i class="fa-solid fa-circle-info animate-pulse"></i>
          </p>
          <div
            class="grid grid-cols-5 gap-1 text-center font-mono font-bold mb-1"
          >
            <div class="text-3xl text-red-300">10</div>
            <div class="text-3xl text-orange-300">9</div>
            <div class="text-3xl text-emerald-300">8</div>
            <div class="text-3xl text-blue-300">7</div>
            <div class="text-3xl text-slate-400">6</div>
          </div>
          <div
            class="grid grid-cols-5 gap-1 text-center text-[8px] sm:text-[10px] font-bold uppercase text-slate-400"
          >
            <div>Failure</div>
            <div>Sisa 1</div>
            <div>Sisa 2</div>
            <div>Sisa 3</div>
            <div>Warm-up</div>
          </div>
        </div>
        <div id="exercise-list" class="space-y-4"></div>
        <button
          onclick="APP.data.addNewExerciseCard()"
          class="w-full bg-slate-800 border border-slate-700 border-dashed text-slate-400 py-3 rounded-xl hover:text-white hover:border-emerald-500 hover:bg-slate-700/50 transition mb-4"
        >
          <i class="fa-solid fa-plus mr-2"></i> Tambah Gerakan Baru
        </button>
        <div class="pt-2 pb-10">
          <button
            onclick="APP.core.finishSession()"
            class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition"
          >
            <i class="fa-solid fa-flag-checkered"></i> SELESAI & SIMPAN LOG
          </button>
        </div>
      </div>
    </main>
    <div id="toast-container"></div>

    <!-- DEEP SESSION EDITOR MODAL -->
    <div
      id="session-editor-modal"
      class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-2xl rounded-2xl border border-slate-700 p-5 flex flex-col fade-in max-h-[90vh]"
      >
        <div
          class="flex justify-between items-center mb-4 pb-3 border-b border-slate-700"
        >
          <h3 class="font-bold text-white text-lg">
            <i class="fa-solid fa-pen-to-square text-emerald-400 mr-2"></i>
            Edit Sesi Lengkap
          </h3>
          <button
            onclick="APP.ui.closeModal('session-editor')"
            class="text-slate-400 hover:text-white"
          >
            <i class="fa-solid fa-xmark fa-lg"></i>
          </button>
        </div>

        <div class="overflow-y-auto no-scrollbar flex-1 space-y-4">
          <!-- Session Metadata -->
          <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
            <h4
              class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center"
            >
              <i class="fa-solid fa-tag mr-2"></i>Session Metadata
            </h4>

            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label class="text-[10px] text-slate-500 block mb-1"
                  >Label Tag</label
                >
                <input
                  type="text"
                  id="edit-session-label"
                  class="w-full bg-slate-950 border border-slate-700 text-white text-sm p-2 rounded focus:border-emerald-500"
                  placeholder="UPPER A"
                />
              </div>
              <div>
                <label class="text-[10px] text-slate-500 block mb-1"
                  >Session Name</label
                >
                <input
                  type="text"
                  id="edit-session-title"
                  class="w-full bg-slate-950 border border-slate-700 text-white text-sm p-2 rounded focus:border-emerald-500"
                  placeholder="Upper Body Strength"
                />
              </div>
            </div>

            <div>
              <label class="text-[10px] text-slate-500 block mb-1"
                >Warmup Protocol</label
              >
              <textarea
                id="edit-session-warmup"
                rows="2"
                class="w-full bg-slate-950 border border-slate-700 text-white text-xs p-2 rounded focus:border-emerald-500"
                placeholder="Arm Circles, Band Pull-Aparts, Light Cardio"
              ></textarea>
            </div>

            <!-- Rotation Control -->
            <div class="mt-3 pt-3 border-t border-slate-700">
              <div class="flex justify-between items-center">
                <div>
                  <p class="text-[10px] text-slate-400 font-bold uppercase">
                    Rotation Status
                  </p>
                  <p id="rotation-status" class="text-xs text-slate-300 mt-1">
                    Last performed: <span class="text-emerald-400">Never</span>
                  </p>
                </div>
                <button
                  onclick="APP.session.resetRotation()"
                  class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg font-bold transition"
                  title="Tandai sesi ini sebagai 'belum pernah dilakukan' agar muncul sebagai Next Workout"
                >
                  <i class="fa-solid fa-rotate-left mr-1"></i>Reset Rotation
                </button>
              </div>
            </div>
          </div>

          <!-- Live Volume Preview -->
          <div
            id="live-volume-preview"
            class="bg-gradient-to-br from-indigo-900/30 to-slate-900/50 p-4 rounded-xl border border-indigo-500/30"
          >
            <h4
              class="text-xs font-bold text-indigo-300 uppercase mb-3 flex items-center"
            >
              <i class="fa-solid fa-chart-bar mr-2"></i>Live Volume Distribution
            </h4>
            <div id="volume-bars-container" class="space-y-2">
              <!-- Dynamically populated -->
            </div>
          </div>

          <!-- Exercise List -->
          <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
            <div class="flex justify-between items-center mb-3">
              <h4
                class="text-xs font-bold text-slate-400 uppercase flex items-center"
              >
                <i class="fa-solid fa-dumbbell mr-2"></i>Exercises
                <span
                  id="exercise-count-badge"
                  class="ml-2 text-[10px] bg-emerald-600 text-white px-2 py-0.5 rounded"
                  >0</span
                >
              </h4>
              <button
                onclick="APP.session.addExerciseToSession()"
                class="text-xs bg-emerald-600 hover:bg-emerald-500 text-white px-3 py-2 rounded-lg font-bold transition flex items-center gap-1"
              >
                <i class="fa-solid fa-plus"></i> Add Exercise
              </button>
            </div>

            <div
              id="editor-exercise-list"
              class="space-y-2 max-h-[300px] overflow-y-auto no-scrollbar"
            >
              <!-- Dynamically populated -->
            </div>
          </div>
        </div>

        <!-- Footer Actions -->
        <div class="flex gap-2 mt-4 pt-4 border-t border-slate-700">
          <button
            onclick="APP.session.saveSessionEdits()"
            class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl transition active:scale-95 flex items-center justify-center gap-2"
          >
            <i class="fa-solid fa-floppy-disk"></i>
            SAVE CHANGES
          </button>
          <button
            onclick="APP.ui.closeModal('session-editor')"
            class="px-6 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl transition"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- SESSION CREATOR MODAL -->
    <div
      id="session-creator-modal"
      class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-md rounded-2xl border border-emerald-500/50 p-5 flex flex-col fade-in max-h-[90vh] overflow-y-auto"
      >
        <div
          class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700"
        >
          <h3 class="font-bold text-white">
            <i class="fa-solid fa-plus-circle text-emerald-400 mr-2"></i>Buat
            Sesi Baru
          </h3>
          <button
            onclick="APP.ui.closeModal('session-creator')"
            class="text-slate-400 hover:text-white"
          >
            <i class="fa-solid fa-xmark fa-lg"></i>
          </button>
        </div>

        <div class="space-y-4">
          <!-- Session Name -->
          <div>
            <label
              class="text-xs text-slate-400 font-bold uppercase block mb-2"
            >
              Nama Sesi
            </label>
            <input
              type="text"
              id="new-session-name"
              placeholder="contoh: Upper Body A"
              class="w-full bg-slate-900 border border-slate-700 text-white text-sm p-3 rounded-lg focus:border-emerald-500"
            />
          </div>

          <!-- Session Label -->
          <div>
            <label
              class="text-xs text-slate-400 font-bold uppercase block mb-2"
            >
              Label Tag
            </label>
            <input
              type="text"
              id="new-session-label"
              placeholder="contoh: UPPER A"
              class="w-full bg-slate-900 border border-slate-700 text-white text-sm p-3 rounded-lg focus:border-emerald-500"
            />
          </div>

          <!-- Warmup Protocol -->
          <div>
            <label
              class="text-xs text-slate-400 font-bold uppercase block mb-2"
            >
              Warmup Protocol
            </label>
            <textarea
              id="new-session-warmup"
              placeholder="contoh: Arm Circles, Band Pull-Aparts"
              rows="2"
              class="w-full bg-slate-900 border border-slate-700 text-white text-sm p-3 rounded-lg focus:border-emerald-500"
            ></textarea>
          </div>

          <!-- Create Options -->
          <div class="border-t border-slate-700 pt-4">
            <p class="text-xs text-slate-400 mb-3 font-bold uppercase">
              Pilih Metode
            </p>

            <div class="grid grid-cols-1 gap-2">
              <button
                onclick="APP.session.createEmpty()"
                class="bg-slate-700 hover:bg-slate-600 text-white text-sm font-bold py-3 px-4 rounded-lg flex items-center gap-3 transition active:scale-95"
              >
                <i class="fa-solid fa-file text-emerald-400"></i>
                <div class="text-left">
                  <div>Buat Kosong</div>
                  <div class="text-[10px] text-slate-400 font-normal">
                    Mulai dari nol, tambah exercise manual
                  </div>
                </div>
              </button>

              <button
                onclick="APP.session.showCloneOptions()"
                class="bg-slate-700 hover:bg-slate-600 text-white text-sm font-bold py-3 px-4 rounded-lg flex items-center gap-3 transition active:scale-95"
              >
                <i class="fa-solid fa-clone text-blue-400"></i>
                <div class="text-left">
                  <div>Clone dari Sesi Lain</div>
                  <div class="text-[10px] text-slate-400 font-normal">
                    Salin struktur sesi existing
                  </div>
                </div>
              </button>
            </div>

            <!-- Clone Options (Hidden by default) -->
            <div id="clone-options" class="hidden mt-3">
              <label
                class="text-xs text-slate-400 font-bold uppercase block mb-2"
              >
                Pilih Sesi untuk di-Clone
              </label>
              <select
                id="clone-source-select"
                class="w-full bg-slate-900 border border-slate-700 text-white text-sm p-3 rounded-lg"
              >
                <option value="">-- Pilih Sesi --</option>
              </select>
              <button
                onclick="APP.session.createClone()"
                class="w-full mt-2 bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded-lg transition"
              >
                Clone Sekarang
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      id="spontaneous-modal"
      class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-md rounded-2xl border border-indigo-500/50 p-5 flex flex-col fade-in max-h-[90vh]"
      >
        <div
          class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700"
        >
          <h3 class="font-bold text-white">
            <i class="fa-solid fa-bolt text-indigo-400 mr-2"></i>Spontaneous
            Session
          </h3>
          <button
            onclick="APP.ui.closeModal('spontaneous')"
            class="text-slate-400 hover:text-white"
          >
            <i class="fa-solid fa-xmark fa-lg"></i>
          </button>
        </div>
        <div class="overflow-y-auto no-scrollbar space-y-4">
          <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
            <p class="text-xs text-slate-400 mb-2 font-bold uppercase">
              Manual Start
            </p>
            <button
              onclick="APP.session.spontaneous.startEmpty()"
              class="w-full bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition active:scale-95"
            >
              <i class="fa-solid fa-plus"></i> Buat Sesi Kosong (Express)
            </button>
          </div>
          <div
            class="bg-indigo-900/20 p-4 rounded-xl border border-indigo-500/30"
          >
            <p class="text-xs text-indigo-300 mb-2 font-bold uppercase">
              Blueprints (Presets)
            </p>
            <div id="blueprint-list" class="space-y-2"></div>
          </div>
          <div class="bg-slate-900/50 p-4 rounded-xl border border-slate-700">
            <p class="text-xs text-slate-400 mb-2 font-bold uppercase">
              JSON Box
            </p>
            <textarea
              id="spon-json-input"
              class="w-full bg-slate-950 text-indigo-300 font-mono text-[10px] p-3 rounded-lg border border-slate-700 h-20 focus:border-indigo-500 mb-2"
              placeholder="Paste JSON Sesi Spontan..."
            ></textarea>
            <div class="grid grid-cols-2 gap-2 mb-3">
              <button
                onclick="APP.session.spontaneous.loadFromJSON()"
                class="bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold py-2 rounded-lg"
              >
                <i class="fa-solid fa-play mr-1"></i> Load JSON
              </button>
              <button
                onclick="APP.session.spontaneous.saveToPresets()"
                class="bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-2 rounded-lg"
              >
                <i class="fa-solid fa-floppy-disk mr-1"></i> Simpan Preset
              </button>
            </div>
            <p class="text-[10px] text-slate-500 font-bold uppercase mb-2">
              Saved Presets
            </p>
            <div
              id="spon-preset-list"
              class="space-y-1 text-center text-[10px] text-slate-500 italic"
            >
              Belum ada preset tersimpan.
            </div>
          </div>
        </div>
      </div>
    </div>
    <div
      id="error-modal"
      class="fixed inset-0 bg-red-900/90 z-[999] hidden flex items-center justify-center p-4 backdrop-blur-md"
    >
      <div
        class="bg-slate-900 w-full max-w-md rounded-2xl border-2 border-red-500 p-5 shadow-2xl"
      >
        <div
          class="flex items-center gap-3 mb-4 text-red-500 border-b border-red-500/30 pb-3"
        >
          <i class="fa-solid fa-bug text-2xl animate-pulse"></i>
          <h3 class="font-bold text-lg">System Crash Diagnosis</h3>
        </div>
        <p class="text-xs text-slate-300 mb-2">
          Terjadi kesalahan sistem. Silakan salin log di bawah dan kirim ke
          Gemini untuk perbaikan instan.
        </p>
        <textarea
          id="error-log-text"
          class="w-full bg-slate-950 text-red-300 font-mono text-[10px] p-3 rounded-lg border border-red-900 h-32 focus:border-red-500 mb-3"
          readonly
        ></textarea>
        <div class="grid grid-cols-2 gap-2">
          <button
            onclick="APP.debug.copyErrorLog()"
            class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition active:scale-95"
          >
            <i class="fa-regular fa-copy"></i> Salin Log</button
          ><button
            onclick="location.reload()"
            class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition active:scale-95"
          >
            <i class="fa-solid fa-rotate-right"></i> Refresh App
          </button>
        </div>
      </div>
    </div>
    <div
      id="rpe-modal"
      class="fixed inset-0 bg-black/95 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 p-5 fade-in"
      >
        <div
          class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2"
        >
          <h3 class="font-bold text-emerald-400">
            <i class="fa-solid fa-layer-group mr-2"></i>Pedoman Skala RPE & RIR
          </h3>
          <button
            onclick="APP.ui.closeModal('rpe')"
            class="text-slate-400 hover:text-white"
          >
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="bg-slate-700 text-emerald-400 text-[10px] uppercase">
                <th class="p-2 border border-slate-600 text-center w-1/6">
                  RPE
                </th>
                <th class="p-2 border border-slate-600 text-center w-1/6">
                  Sisa (RIR)
                </th>
                <th class="p-2 border border-slate-600 text-left">
                  Indikator Fisik/Rasa
                </th>
              </tr>
            </thead>
            <tbody class="text-slate-300 text-[11px]">
              <tr class="bg-slate-900/50">
                <td
                  class="p-2 border border-slate-600 font-bold text-center text-red-500 text-sm"
                >
                  10
                </td>
                <td class="p-2 border border-slate-600 text-center font-bold">
                  0
                </td>
                <td class="p-2 border border-slate-600">
                  Usaha MAKSIMAL. Tidak bisa angkat lagi (Failure teknis/otot).
                </td>
              </tr>
              <tr>
                <td
                  class="p-2 border border-slate-600 font-bold text-center text-red-400"
                >
                  9.5
                </td>
                <td class="p-2 border border-slate-600 text-center">0 - 1</td>
                <td class="p-2 border border-slate-600">
                  Mungkin bisa 1 lagi jika nyawa terancam. Gerakan sangat
                  lambat.
                </td>
              </tr>
              <tr class="bg-slate-900/50">
                <td
                  class="p-2 border border-slate-600 font-bold text-center text-orange-400"
                >
                  9
                </td>
                <td class="p-2 border border-slate-600 text-center font-bold">
                  1
                </td>
                <td class="p-2 border border-slate-600">
                  Pasti bisa 1 repetisi lagi dengan teknik benar. Berat tapi
                  selesai.
                </td>
              </tr>
              <tr>
                <td
                  class="p-2 border border-slate-600 font-bold text-center text-emerald-400"
                >
                  8
                </td>
                <td class="p-2 border border-slate-600 text-center font-bold">
                  2
                </td>
                <td class="p-2 border border-slate-600">
                  Beban kerja ideal. Berat, kecepatan bar terkontrol baik.
                </td>
              </tr>
              <tr class="bg-slate-900/50">
                <td
                  class="p-2 border border-slate-600 font-bold text-center text-blue-400"
                >
                  7
                </td>
                <td class="p-2 border border-slate-600 text-center">3+</td>
                <td class="p-2 border border-slate-600">
                  Terasa ringan, gerakan eksplosif. Untuk pemanasan/power.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div
      id="library-modal"
      class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 p-5 flex flex-col fade-in max-h-[90vh]"
      >
        <div
          class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700"
        >
          <h3 class="font-bold text-white">
            <i class="fa-solid fa-book-bookmark text-indigo-400 mr-2"></i
            >Library & AI Bridge
          </h3>
          <button
            onclick="APP.ui.closeModal('library')"
            class="text-slate-400 hover:text-white"
          >
            <i class="fa-solid fa-xmark fa-lg"></i>
          </button>
        </div>
        <div class="space-y-4 overflow-y-auto no-scrollbar">
          <button
            onclick="APP.data.prepareGeminiAudit()"
            class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 shadow-lg transition active:scale-95 mb-2"
          >
            <i class="fa-solid fa-robot"></i> SIAPKAN AUDIT GEMINI
          </button>
          <div
            class="bg-indigo-900/20 p-4 rounded-xl border border-indigo-500/30"
          >
            <p class="text-xs text-indigo-300 mb-2 font-bold uppercase">
              Program Management
            </p>
            <div class="grid grid-cols-2 gap-2 mb-2">
              <button
                onclick="APP.data.saveToLibrary()"
                class="bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition active:scale-95"
              >
                <i class="fa-solid fa-floppy-disk"></i> Simpan Resep
              </button>
              <button
                onclick="APP.data.exportForConsultation()"
                class="bg-emerald-600 hover:bg-emerald-500 text-white text-[10px] font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition active:scale-95 shadow-lg shadow-emerald-900/50"
              >
                <i class="fa-solid fa-file-export"></i> Salin Log Latihan
              </button>
            </div>
            <button
              onclick="APP.data.copyProgramToClipboard()"
              class="w-full bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs font-bold py-2 rounded-lg flex items-center justify-center gap-2 transition active:scale-95"
            >
              <i class="fa-regular fa-copy"></i> Salin JSON Resep Latihan
            </button>
          </div>
          <div>
            <p
              class="text-xs text-slate-400 mb-2 font-bold uppercase border-b border-slate-700 pb-1"
            >
              Daftar Resep Tersimpan
            </p>
            <div id="library-list" class="space-y-2">
              <p class="text-[10px] text-slate-500 text-center italic py-2">
                Belum ada program tersimpan.
              </p>
            </div>
          </div>
          <div
            class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 mb-4"
          >
            <p class="text-xs text-slate-400 mb-2 font-bold uppercase">
              Terapkan Resep Baru (Output Gemini)
            </p>
            <textarea
              id="ai-input"
              class="w-full bg-slate-950 text-emerald-400 font-mono text-[10px] p-3 rounded-lg border border-slate-700 h-20 focus:border-emerald-500 mb-3"
              placeholder="Paste JSON baru dari Gemini di sini (Satu Sesi atau Full)..."
            ></textarea>
            <button
              onclick="APP.data.applyAIProgram()"
              class="w-full bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition active:scale-95"
            >
              <i class="fa-solid fa-wand-magic-sparkles"></i> Terapkan Program
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      id="calc-modal"
      class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 p-5 fade-in"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-white">
            <i class="fa-solid fa-calculator text-yellow-400 mr-2"></i>Warm-Up &
            Plates
          </h3>
          <button onclick="APP.ui.closeModal('calc')" class="text-slate-400">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="flex gap-2 mb-4 items-center justify-center">
          <span class="text-slate-400 text-xs">Target:</span
          ><span id="calc-target" class="text-2xl font-bold text-white">0</span
          ><span class="text-slate-400 text-xs">kg</span>
        </div>
        <div class="flex justify-center mb-4">
          <span
            id="calc-type-badge"
            class="px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-slate-700 text-slate-400"
            >Standard</span
          >
        </div>
        <div
          id="calc-steps"
          class="space-y-2 max-h-[300px] overflow-y-auto no-scrollbar"
        ></div>
        <p class="text-[10px] text-slate-500 text-center mt-3 italic">
          Rincian pelat per sisi (Asumsi bar 20kg).
        </p>
      </div>
    </div>
    <div
      id="stats-modal"
      class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 p-5 flex flex-col max-h-[90vh] fade-in"
      >
        <div
          class="flex justify-between items-center mb-4 border-b border-slate-700 pb-3"
        >
          <h3 class="font-bold text-white">Clinical Analytics</h3>
          <button onclick="APP.ui.closeModal('stats')" class="text-slate-400">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div id="exercise-selector-container" class="mb-4">
          <select
            id="stats-select"
            onchange="APP.stats.updateChart()"
            class="w-full bg-slate-900 text-white text-sm p-3 rounded-xl border border-slate-600 mt-1"
          ></select>
        </div>
        <div class="mb-3">
          <div class="flex gap-2 justify-center mb-2">
            <button
              id="tab-dashboard"
              onclick="APP.stats.switchTab('dashboard')"
              class="tab-btn active w-12 h-12 flex items-center justify-center text-xl rounded-lg transition-all"
            >
              
            </button>
            <button
              id="tab-chart"
              onclick="APP.stats.switchTab('chart')"
              class="tab-btn inactive w-12 h-12 flex items-center justify-center text-xl rounded-lg transition-all"
            >
              
            </button>
            <button
              id="tab-table"
              onclick="APP.stats.switchTab('table')"
              class="tab-btn inactive w-12 h-12 flex items-center justify-center text-xl rounded-lg transition-all"
            >
              
            </button>
            <button
              id="tab-bodyparts"
              onclick="APP.stats.switchTab('bodyparts')"
              class="tab-btn inactive w-12 h-12 flex items-center justify-center text-xl rounded-lg transition-all"
            >
              
            </button>
          </div>

          <div class="text-center">
            <span
              id="active-tab-label"
              class="text-xs font-bold text-emerald-400 uppercase tracking-wider"
            >
              Dashboard
            </span>
          </div>
        </div>
        <div
          id="stats-dashboard-view"
          class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 flex-1 min-h-[350px] overflow-y-auto no-scrollbar mb-4"
        >
          <div class="mb-6">
            <h3
              class="text-xs text-slate-400 uppercase font-bold mb-3 flex items-center gap-2"
            >
              <i class="fa-solid fa-calendar-week"></i> This Week vs Last Week
            </h3>
            <div class="grid grid-cols-2 gap-3">
              <div
                class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"
              >
                <div class="text-[10px] text-slate-400 mb-1">Total Volume</div>
                <div class="flex items-baseline gap-2">
                  <span
                    id="dash-volume-current"
                    class="text-2xl font-bold text-white"
                    >0</span
                  >
                  <span class="text-xs text-slate-500">kg</span>
                </div>
                <div id="dash-volume-diff" class="text-xs font-bold mt-1">
                  <span class="text-slate-400">No data</span>
                </div>
              </div>

              <div
                class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"
              >
                <div class="text-[10px] text-slate-400 mb-1">Avg RPE</div>
                <div class="flex items-baseline gap-2">
                  <span
                    id="dash-rpe-current"
                    class="text-2xl font-bold text-white"
                    >0</span
                  >
                </div>
                <div id="dash-rpe-diff" class="text-xs font-bold mt-1">
                  <span class="text-slate-400">No data</span>
                </div>
              </div>

              <div
                class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"
              >
                <div class="text-[10px] text-slate-400 mb-1">Sessions</div>
                <div class="flex items-baseline gap-2">
                  <span
                    id="dash-sessions-current"
                    class="text-2xl font-bold text-white"
                    >0</span
                  >
                </div>
                <div id="dash-sessions-diff" class="text-xs font-bold mt-1">
                  <span class="text-slate-400">No data</span>
                </div>
              </div>

              <div
                class="bg-slate-800/50 p-3 rounded-lg border border-slate-700"
              >
                <div class="text-[10px] text-slate-400 mb-1">Tonnage</div>
                <div class="flex items-baseline gap-2">
                  <span
                    id="dash-tonnage-current"
                    class="text-2xl font-bold text-white"
                    >0</span
                  >
                  <span class="text-xs text-slate-500">kg</span>
                </div>
                <div id="dash-tonnage-diff" class="text-xs font-bold mt-1">
                  <span class="text-slate-400">No data</span>
                </div>
              </div>
            </div>
          </div>

          <div class="mb-6">
            <h3
              class="text-xs text-slate-400 uppercase font-bold mb-3 flex items-center gap-2"
            >
              <i class="fa-solid fa-trophy"></i> Top Gainers (Volume %)
            </h3>
            <div id="dash-top-gainers" class="space-y-2">
              <p class="text-xs text-slate-500 italic">
                Complete more sessions to see gainers.
              </p>
            </div>
          </div>

          <div id="dash-fatigue-alert" class="hidden">
            <div class="bg-red-900/20 border border-red-900/50 rounded-lg p-3">
              <div class="flex items-start gap-2">
                <i
                  class="fa-solid fa-triangle-exclamation text-red-400 mt-0.5"
                ></i>
                <div>
                  <div class="text-xs font-bold text-red-400 mb-1">
                    Fatigue Alert
                  </div>
                  <div id="dash-fatigue-message" class="text-xs text-slate-300">
                    High RPE detected. Consider rest.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div
          id="stats-chart-view"
          class="bg-slate-900/50 p-2 rounded-xl border border-slate-700 flex-1 min-h-[250px] relative mb-4"
        >
          <canvas id="progressChart"></canvas>
          <div
            id="no-data-msg"
            class="absolute inset-0 flex items-center justify-center text-slate-500 text-xs hidden"
          >
            No Data.
          </div>
        </div>
        <div
          id="stats-table-view"
          class="bg-slate-900/50 p-2 rounded-xl border border-slate-700 flex-1 min-h-[250px] relative mb-4 hidden overflow-y-auto no-scrollbar"
        >
          <table class="hist-table">
            <thead>
              <tr>
                <th>TGL</th>
                <th>BEBAN</th>
                <th>REPS</th>
                <th>RPE</th>
                <th>VOL</th>
              </tr>
            </thead>
            <tbody id="hist-table-body"></tbody>
          </table>
        </div>
        <div
          id="stats-bodyparts-view"
          class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 flex-1 min-h-[350px] overflow-y-auto no-scrollbar mb-4 hidden"
        >
          <div class="mb-4">
            <!--  INSERT THIS BEFORE <select id="bodypart-period"> -->
            <div class="mb-4">
              <div class="flex gap-2 justify-center">
                <button
                  id="view-combined-btn"
                  onclick="APP.stats.setBodyPartView('combined')"
                  class="px-4 py-2 text-xs font-bold rounded-lg transition-all duration-300 bg-emerald-600 text-white"
                >
                   Combined View
                </button>
                <button
                  id="view-split-btn"
                  onclick="APP.stats.setBodyPartView('split')"
                  class="px-4 py-2 text-xs font-bold rounded-lg transition-all duration-300 bg-slate-700 text-slate-400"
                >
                   Split View (Upper/Lower)
                </button>
              </div>
              <p class="text-[9px] text-slate-500 text-center mt-2 italic">
                Combined: All muscles vs Legs baseline | Split: Fair comparison
                per region
              </p>
            </div>
            <select
              id="bodypart-period"
              onchange="APP.stats.updateBodyParts()"
              class="w-full bg-slate-800 text-white text-xs p-2 rounded border border-slate-600"
            >
              <option value="4">Last 4 Weeks</option>
              <option value="8">Last 8 Weeks</option>
              <option value="12">Last 12 Weeks</option>
            </select>
          </div>

          <div class="mb-6">
            <h3 class="text-xs text-slate-400 uppercase font-bold mb-3">
              Volume by Muscle Group
            </h3>
            <div id="bodypart-bars" class="space-y-3">
              <p class="text-xs text-slate-500 italic">Loading...</p>
            </div>
          </div>

          <div id="bodypart-imbalance" class="hidden">
            <div
              class="bg-yellow-900/20 border border-yellow-900/50 rounded-lg p-3"
            >
              <div class="flex items-start gap-2">
                <i
                  class="fa-solid fa-scale-unbalanced text-yellow-400 mt-0.5"
                ></i>
                <div>
                  <div class="text-xs font-bold text-yellow-400 mb-1">
                    Imbalance Detected
                  </div>
                  <div
                    id="bodypart-imbalance-message"
                    class="text-xs text-slate-300"
                  >
                    Checking balance...
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="vital-signs" class="grid grid-cols-3 gap-2 text-center hidden">
          <div class="bg-slate-700/30 p-2 rounded border border-slate-700">
            <div class="text-[10px] text-slate-400 uppercase">PR</div>
            <div class="text-lg font-bold text-emerald-400" id="stat-pr">
              --
            </div>
          </div>
          <div class="bg-slate-700/30 p-2 rounded border border-slate-700">
            <div class="text-[10px] text-slate-400 uppercase">Vol Avg</div>
            <div class="text-lg font-bold text-blue-400" id="stat-vol">--</div>
          </div>
          <div class="bg-slate-700/30 p-2 rounded border border-slate-700">
            <div class="text-[10px] text-slate-400 uppercase">Count</div>
            <div class="text-lg font-bold text-white" id="stat-count">--</div>
          </div>
        </div>
      </div>
    </div>
    <div
      id="profile-modal"
      class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 p-5 space-y-4 fade-in overflow-y-auto max-h-[90vh]"
      >
        <div class="flex justify-between">
          <h3 class="font-bold text-white">Profil</h3>
          <button onclick="APP.ui.closeModal('profile')" class="text-slate-400">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="space-y-3">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <span class="text-[10px] text-slate-400">Nama</span
              ><input
                type="text"
                id="prof-name"
                class="w-full p-2 bg-slate-900 rounded text-white text-sm"
              />
            </div>
            <div>
              <span class="text-[10px] text-slate-400">Tinggi</span
              ><input
                type="number"
                id="prof-height"
                class="w-full p-2 bg-slate-900 rounded text-white text-sm"
              />
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <span class="text-[10px] text-slate-400">Usia</span
              ><input
                type="number"
                id="prof-age"
                class="w-full p-2 bg-slate-900 rounded text-white text-sm"
              />
            </div>
            <div>
              <span class="text-[10px] text-slate-400">Gender</span
              ><select
                id="prof-gender"
                class="w-full p-2 bg-slate-900 rounded text-white text-sm"
              >
                <option value="male">Pria</option>
                <option value="female">Wanita</option>
              </select>
            </div>
          </div>
          <div>
            <span class="text-[10px] text-slate-400">Aktivitas</span
            ><select
              id="prof-active"
              class="w-full p-2 bg-slate-900 rounded text-white text-sm"
            >
              <option value="1.2">Sedentary (Tidak ada olahraga)</option>
              <option value="1.375">Light (1-3 hari/minggu)</option>
              <option value="1.55">Moderate (3-5 hari/minggu)</option>
              <option value="1.725">Active (6-7 hari/minggu)</option>
            </select>
          </div>
          <div
            id="tdee-box"
            class="bg-slate-900/60 border border-slate-700/50 rounded-2xl p-5 mb-6 text-center hidden shadow-lg"
          >
            <div class="mb-1">
              <span
                class="text-slate-500 text-[10px] uppercase tracking-[0.2em] font-black"
                >Kebutuhan Kalori Harian</span
              >
            </div>
            <div class="flex items-baseline justify-center gap-1 mb-5">
              <span
                id="tdee-val"
                class="text-5xl font-black text-orange-400 tracking-tighter"
                >0</span
              >
              <span class="text-slate-500 text-xs font-bold italic"
                >Kkal/Hari</span
              >
            </div>
            <div class="grid grid-cols-2 gap-3 text-xs">
              <div
                class="bg-emerald-500/10 border border-emerald-500/20 p-3 rounded-xl transition-all hover:border-emerald-500/40"
              >
                <span
                  class="text-emerald-500 font-black uppercase text-[9px] block mb-1"
                  >Bulking</span
                >
                <div class="text-emerald-400 font-bold">
                  <span id="bulk-val" class="text-lg">0</span>
                  <span class="opacity-60">Kkal (+300)</span>
                </div>
              </div>
              <div
                class="bg-red-500/10 border border-red-500/20 p-3 rounded-xl transition-all hover:border-red-500/40"
              >
                <span
                  class="text-red-400 font-black uppercase text-[9px] block mb-1"
                  >Cutting</span
                >
                <div class="text-red-400 font-bold">
                  <span id="cut-val" class="text-lg">0</span>
                  <span class="opacity-60">Kkal (-500)</span>
                </div>
              </div>
            </div>
          </div>
          <button
            onclick="APP.data.saveProfile()"
            class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg"
          >
            Simpan Profil
          </button>
        </div>
        <div
          class="bg-slate-900/50 p-4 rounded-xl border border-slate-700 mb-4"
        >
          <h4
            class="text-xs font-bold text-slate-400 mb-2 uppercase flex justify-between"
          >
            <span
              ><i class="fa-solid fa-database mr-1"></i> Storage Status</span
            >
            <button
              onclick="APP.showStorageStats()"
              class="text-blue-400 hover:text-blue-300"
            >
              <i class="fa-solid fa-rotate"></i>
            </button>
          </h4>
          <div id="storage-stats" class="grid grid-cols-2 gap-2 text-xs">
            <div class="bg-slate-800 p-2 rounded">
              <div class="text-slate-500 text-[10px]">Items</div>
              <div class="text-white font-bold" id="stat-items">--</div>
            </div>
            <div class="bg-slate-800 p-2 rounded">
              <div class="text-slate-500 text-[10px]">Size</div>
              <div class="text-white font-bold" id="stat-size">--</div>
            </div>
            <div class="bg-slate-800 p-2 rounded col-span-2">
              <div class="text-slate-500 text-[10px]">Usage</div>
              <div class="flex items-center gap-2">
                <div
                  class="flex-1 bg-slate-700 rounded-full h-2 overflow-hidden"
                >
                  <div
                    id="usage-bar"
                    class="bg-emerald-500 h-full transition-all"
                    style="width: 0%"
                  ></div>
                </div>
                <span class="text-white font-bold text-[10px]" id="stat-usage"
                  >0%</span
                >
              </div>
            </div>
          </div>
        </div>

        <div
          class="mt-6 p-4 rounded-xl border border-teal-500/40 bg-teal-900/20"
        >
          <div
            class="mb-4 p-4 bg-indigo-900/30 rounded-2xl border border-indigo-500/30 shadow-inner"
          >
            <h3
              class="text-[10px] font-bold text-indigo-400 mb-3 uppercase tracking-widest flex items-center"
            >
              <i class="fa-solid fa-cloud mr-2"></i> Cloud Sync (G-Drive)
            </h3>
            <div class="grid grid-cols-2 gap-2">
              <button
                onclick="syncToCloud()"
                class="bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold text-xs transition active:scale-95 flex flex-col items-center gap-1"
              >
                <i class="fa-solid fa-cloud-arrow-up text-base"></i> Backup
              </button>
              <button
                onclick="restoreFromCloud()"
                class="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold text-xs transition active:scale-95 flex flex-col items-center gap-1"
              >
                <i class="fa-solid fa-cloud-arrow-down text-base"></i> Restore
              </button>
            </div>
            <p
              class="text-[9px] text-slate-500 mt-2 text-center italic leading-tight"
            >
              Backup disimpan aman di AppData Google Drive.
            </p>
          </div>
          <div class="border-t border-slate-700 pt-3 mt-2">
            <div class="grid grid-cols-2 gap-4">
              <button
                onclick="APP.data.exportData()"
                class="bg-slate-700 text-emerald-400 text-xs py-2 rounded"
              >
                Backup Manual</button
              ><label
                class="bg-slate-700 text-blue-400 text-xs py-2 rounded text-center cursor-pointer"
                >Restore Manual<input
                  type="file"
                  id="import-file"
                  class="hidden"
                  onchange="APP.data.importData(this)"
              /></label>
            </div>
          </div>
        </div>
        <div class="mt-6 p-4 rounded-xl border border-red-900/30 bg-red-950/20">
          <h4
            class="text-red-400 font-bold text-[10px] mb-2 uppercase tracking-wide"
          >
            <i class="fa-solid fa-triangle-exclamation mr-1"></i> Data Danger
            Zone
          </h4>
          <div class="grid grid-cols-1 gap-2">
            <button
              onclick="APP.data.deleteLogs('today')"
              class="w-full bg-slate-700 text-slate-300 text-xs py-2 rounded hover:bg-red-900/50 hover:text-red-400 transition text-left px-3 flex justify-between items-center"
            >
              <span>Hapus Log Hari Ini</span> <i class="fa-solid fa-trash"></i>
            </button>
            <div class="flex gap-2">
              <input
                type="date"
                id="del-date-picker"
                class="bg-slate-900 text-white text-xs p-2 rounded border border-slate-700 flex-1"
              />
              <button
                onclick="APP.data.deleteLogs('date')"
                class="bg-slate-700 text-slate-300 text-xs px-3 rounded hover:bg-red-900/50 hover:text-red-400 transition whitespace-nowrap"
              >
                Hapus Tgl Ini
              </button>
            </div>
            <button
              onclick="APP.data.deleteLogs('all')"
              class="w-full bg-red-900/30 border border-red-900/50 text-red-400 font-bold text-xs py-3 rounded mt-2 hover:bg-red-900 hover:text-white transition flex items-center justify-center gap-2 shadow-lg shadow-red-900/10"
            >
              <i class="fa-solid fa-radiation"></i> RESET TOTAL (FRESH START)
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      id="weight-modal"
      class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 p-5 fade-in"
      >
        <div class="flex justify-between mb-4">
          <h3 class="font-bold text-white">Weight</h3>
          <button onclick="APP.ui.closeModal('weight')" class="text-slate-400">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="flex gap-2 mb-4">
          <input
            type="number"
            id="new-weight"
            placeholder="00.0"
            class="flex-1 bg-slate-900 text-white p-3 rounded-lg text-center font-bold border-slate-700"
          /><button
            onclick="APP.data.addWeight()"
            class="bg-emerald-600 text-white px-5 rounded-lg"
          >
            <i class="fa-solid fa-plus"></i>
          </button>
        </div>
        <div
          id="weight-list"
          class="space-y-2 max-h-60 overflow-y-auto no-scrollbar"
        ></div>
      </div>
    </div>
    <div
      id="exercise-picker-modal"
      class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
      onclick="if(event.target.id === 'exercise-picker-modal') APP.ui.closeModal('exercise-picker')"
    >
      <div
        class="bg-slate-800 w-full max-w-2xl rounded-2xl border border-slate-700 p-5 flex flex-col fade-in max-h-[90vh] min-h-[500px]"
      >
        <div
          class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700"
        >
          <h3 class="font-bold text-white text-lg">
            <i class="fa-solid fa-dumbbell text-emerald-400 mr-2"></i>Exercise
            Library
          </h3>
          <button
            onclick="APP.ui.closeModal('exercise-picker')"
            class="text-slate-400 hover:text-white cursor-pointer"
          >
            <i class="fa-solid fa-xmark fa-lg"></i>
          </button>
        </div>
        <div class="mb-3">
          <input
            type="text"
            id="exercise-search"
            placeholder="Cari exercise..."
            class="w-full bg-slate-900 border border-slate-700 text-white text-sm p-2 rounded mb-2"
            onkeyup="APP.ui.filterExercises()"
          />
          <div class="flex gap-2 flex-wrap" id="category-filter">
            <button
              onclick="APP.ui.filterByCategory('all')"
              class="text-[10px] px-2 py-1 rounded bg-emerald-600 text-white font-bold active-category"
            >
              All
            </button>
          </div>
        </div>
        <div
          id="picker-exercise-list"
          class="space-y-2 overflow-y-auto no-scrollbar flex-1 mb-3"
        ></div>
        <div class="pt-3 border-t border-slate-700">
          <button
            onclick="APP.ui.closeModal('exercise-picker')"
            class="w-full bg-slate-700 hover:bg-slate-600 text-slate-300 py-2 rounded-lg font-bold text-sm transition"
          >
            <i class="fa-solid fa-arrow-left mr-2"></i>Kembali
          </button>
        </div>
      </div>
    </div>
    <div
      id="bio-modal"
      class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 p-6 max-h-[80vh] flex flex-col fade-in"
      >
        <h3
          class="font-bold text-white text-lg mb-4 text-emerald-400"
          id="bio-title"
        ></h3>
        <div class="overflow-y-auto pr-2 mb-4 no-scrollbar">
          <p
            id="bio-text"
            class="text-slate-300 text-sm whitespace-pre-line leading-relaxed"
          ></p>
        </div>
        <button
          onclick="APP.ui.closeModal('bio')"
          class="w-full bg-slate-700 text-white py-3 rounded-xl font-bold"
        >
          Tutup
        </button>
      </div>
    </div>
    <div
      id="history-modal"
      class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 p-5 max-h-[80vh] flex flex-col fade-in"
      >
        <div class="flex justify-between border-b border-slate-700 pb-2 mb-2">
          <h3 class="font-bold text-white" id="hist-title">History</h3>
          <button onclick="APP.ui.closeModal('history')" class="text-slate-400">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div
          id="hist-content"
          class="overflow-y-auto space-y-2 no-scrollbar"
        ></div>
      </div>
    </div>
    <div
      id="calendar-modal"
      class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm"
    >
      <div
        class="bg-slate-800 w-full max-w-md rounded-2xl border border-slate-700 p-5 flex flex-col fade-in max-h-[90vh]"
      >
        <div
          class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700"
        >
          <h3 class="font-bold text-white">
            <i class="fa-solid fa-calendar-days text-emerald-400 mr-2"></i
            >Jurnal & Performa
          </h3>
          <button
            onclick="APP.ui.closeModal('calendar')"
            class="text-slate-400"
          >
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <div class="flex justify-between items-center mb-4">
          <button
            onclick="APP.ui.changeMonth(-1)"
            class="text-slate-400 hover:text-white px-2"
          >
            <i class="fa-solid fa-chevron-left"></i>
          </button>
          <h4 id="cal-month-year" class="text-white font-bold text-sm"></h4>
          <button
            onclick="APP.ui.changeMonth(1)"
            class="text-slate-400 hover:text-white px-2"
          >
            <i class="fa-solid fa-chevron-right"></i>
          </button>
        </div>
        <div
          class="grid grid-cols-7 gap-1 mb-2 text-center text-[10px] text-slate-500 font-bold uppercase"
        >
          <div>Min</div>
          <div>Sen</div>
          <div>Sel</div>
          <div>Rab</div>
          <div>Kam</div>
          <div>Jum</div>
          <div>Sab</div>
        </div>
        <div id="cal-grid" class="grid grid-cols-7 gap-1 mb-4"></div>
        <div
          id="cal-details"
          class="bg-slate-900/50 p-3 rounded-lg border border-slate-700 min-h-[140px] flex flex-col justify-center overflow-y-auto no-scrollbar"
        >
          <div class="text-center text-slate-500 opacity-70">
            <i class="fa-solid fa-hand-pointer mb-2 text-xl"></i>
            <p class="text-xs italic">
              Klik tanggal hijau untuk melihat detail.
            </p>
          </div>
        </div>
      </div>
    </div>
    <script>
      const PRESETS = {
        p1: {
          label: "Blood Flow",
          title: "The Blood Flow (Active Recovery)",
          dynamic: "Arm Circles, Leg Swings",
          exercises: [
            {
              sets: 3,
              rest: 60,
              note: "Constant Tension (No Lockout)",
              options: [
                {
                  n: "[Machine] Chest Press",
                  t_r: "15-20",
                  bio: "Lakukan gerakan memompa, jangan kunci siku.",
                  note: "Fokus Pompa Darah",
                },
                {
                  n: "[Cable] Face Pull",
                  t_r: "15-20",
                  bio: "Tarik ke arah dahi, fokus rear delt.",
                },
              ],
            },
            {
              sets: 3,
              rest: 60,
              note: "Slow Eccentric",
              options: [
                {
                  n: "[Machine] Leg Extension",
                  t_r: "15-20",
                  bio: "Tahan 1 detik di puncak kontraksi.",
                  note: "Tahan Puncak",
                },
                {
                  n: "[Machine] Leg Curl",
                  t_r: "15-20",
                  bio: "Jaga pinggul tetap menempel di pad.",
                },
              ],
            },
          ],
        },
        p2: {
          label: "Mini Pump",
          title: "Minimalist Pump",
          dynamic: "Arm Circles",
          exercises: [
            {
              sets: 3,
              rest: 90,
              note: "Squeeze at Top",
              options: [
                {
                  n: "[DB] Incline Press",
                  t_r: "10-12",
                  bio: "Tekan dada atas, sudut bangku 30 derajat.",
                },
              ],
            },
            {
              sets: 3,
              rest: 90,
              note: "Full Stretch",
              options: [
                {
                  n: "[Cable] Lat Pulldown",
                  t_r: "10-12",
                  bio: "Biarkan lats terulur maksimal di atas.",
                },
              ],
            },
            {
              sets: 3,
              rest: 90,
              note: "Control Weight",
              options: [
                {
                  n: "[Machine] Leg Press",
                  t_r: "10-12",
                  bio: "Jangan biarkan lutut goyang (valgus).",
                },
              ],
            },
          ],
        },
        p3: {
          label: "Core",
          title: "Core Stability",
          dynamic: "Cat-Cow",
          exercises: [
            {
              sets: 3,
              rest: 60,
              note: "Bracing Focus",
              options: [
                {
                  n: "[Bodyweight] Plank",
                  t_r: "45s",
                  bio: "Kencangkan perut seperti akan dipukul.",
                },
              ],
            },
            {
              sets: 3,
              rest: 60,
              note: "Control",
              options: [
                {
                  n: "[Bodyweight] Deadbug",
                  t_r: "12 reps",
                  bio: "Punggung bawah harus menempel lantai.",
                },
              ],
            },
            {
              sets: 3,
              rest: 60,
              note: "Obliques",
              options: [
                {
                  n: "[Bodyweight] Side Plank",
                  t_r: "30s",
                  bio: "Angkat pinggul tinggi, garis lurus.",
                },
              ],
            },
          ],
        },
        p4: {
          label: "Mobility",
          title: "Upper Mobility Flow",
          dynamic: "Arm Swings",
          exercises: [
            {
              sets: 2,
              rest: 30,
              note: "Thoracic Ext.",
              options: [
                {
                  n: "[Stretch] Cat-Cow",
                  t_r: "10 reps",
                  bio: "Fokus lengkungan di punggung atas.",
                },
              ],
            },
            {
              sets: 2,
              rest: 30,
              note: "Shoulder ROM",
              options: [
                {
                  n: "[Stretch] Band Dislocates",
                  t_r: "10 reps",
                  bio: "Gunakan band elastis, jangan dipaksa.",
                },
              ],
            },
            {
              sets: 2,
              rest: 30,
              note: "Lats Stretch",
              options: [
                {
                  n: "[Stretch] Child Pose",
                  t_r: "30s",
                  bio: "Dorong ketiak ke arah lantai.",
                },
              ],
            },
          ],
        },
        p5: {
          label: "Home",
          title: "Home Flow (No Gear)",
          dynamic: "Jumping Jacks",
          exercises: [
            {
              sets: 3,
              rest: 60,
              note: "Chest Focus",
              options: [
                {
                  n: "[Bodyweight] Push Up",
                  t_r: "Failure",
                  bio: "Siku 45 derajat dari badan, jangan lebar.",
                },
              ],
            },
            {
              sets: 3,
              rest: 60,
              note: "Quads",
              options: [
                {
                  n: "[Bodyweight] Squat",
                  t_r: "20 reps",
                  bio: "Lutut mengikuti arah jari kaki.",
                },
              ],
            },
            {
              sets: 3,
              rest: 60,
              note: "Glutes",
              options: [
                {
                  n: "[Bodyweight] Glute Bridge",
                  t_r: "15 reps",
                  bio: "Kunci pantat di atas, jangan over-arch.",
                },
              ],
            },
          ],
        },
      };
      window.onerror = function (msg, url, line, col, error) {
        APP.debug.showFatalError(
          "System Crash",
          error || msg,
          `Line: ${line}:${col}\nURL: ${url}`
        );
        return false;
      };

      // LS_SAFE and DT moved to js/core.js

      const STARTER_PACK = {
        1704067200000: {
          label: "UPPER",
          title: "Upper Body Foundation",
          dynamic: "Arm Circles, Band Pull-Aparts, Shoulder Dislocates",
          exercises: [
            {
              sets: 3,
              rest: 150,
              note: "Primary compound push - chest focus",
              options: [
                {
                  n: "[Barbell] Bench Press",
                  t_r: "6-8",
                  t_k: 60,
                  vid: "https://www.youtube.com/watch?v=rT7DgCr-3pg",
                  bio: "Gold standard untuk total horizontal pressing power dan densitas otot pectoral.",
                  note: "Gunakan leg drive. Turunkan bar ke sternum bawah. Siku tidak flaring 90 derajat.",
                },
              ],
            },
            {
              sets: 3,
              rest: 120,
              note: "Primary compound pull - back thickness",
              options: [
                {
                  n: "[Barbell] Barbell Row",
                  t_r: "8-10",
                  t_k: 50,
                  vid: "https://www.youtube.com/watch?v=9efgcAjQe7E",
                  bio: "Compound horizontal pull primer untuk ketebalan mid-back dan stabilitas core.",
                  note: "Bent-over 45-60 derajat. Tarik bar ke perut bawah. Squeeze scapula di puncak.",
                },
              ],
            },
            {
              sets: 3,
              rest: 90,
              note: "Vertical press - shoulder development",
              options: [
                {
                  n: "[Barbell] Overhead Press",
                  t_r: "8-10",
                  t_k: 30,
                  vid: "https://www.youtube.com/watch?v=2yjwXTZQDDI",
                  bio: "Membangun kekuatan bahu murni dan stabilitas core.",
                  note: "Mundurkan dagu saat bar naik. Kunci core dan bokong untuk stabilitas lumbal.",
                },
              ],
            },
            {
              sets: 3,
              rest: 90,
              note: "Vertical pull - back width",
              options: [
                {
                  n: "[Cable] Lat Pulldown (wide)",
                  t_r: "10-12",
                  t_k: 55,
                  vid: "https://www.youtube.com/watch?v=CAwf7n6Luuc",
                  bio: "Vertical pull utama untuk membangun lebar punggung (V-Taper).",
                  note: "Tarik bar ke dada atas. Bayangkan siku masuk ke saku celana belakang.",
                },
              ],
            },
            {
              sets: 3,
              rest: 60,
              note: "Arm isolation - biceps",
              options: [
                {
                  n: "[Barbell] Barbell Curl",
                  t_r: "10-12",
                  t_k: 25,
                  vid: "https://www.youtube.com/watch?v=lyn7kj8v_XU",
                  bio: "Membangun massa bicep keseluruhan.",
                  note: "Kunci siku di samping rusuk. Hindari ayunan pinggang. Kontraksi puncak dan turun terkontrol.",
                },
              ],
            },
          ],
        },

        1704067201000: {
          label: "LOWER",
          title: "Lower Body Foundation",
          dynamic: "Leg Swings, Hip Circles, Ankle Mobility",
          exercises: [
            {
              sets: 3,
              rest: 180,
              note: "Primary compound - quad dominant",
              options: [
                {
                  n: "[Barbell] Barbell Squat",
                  t_r: "6-8",
                  t_k: 80,
                  vid: "https://www.youtube.com/watch?v=gcNh17Ckjgg",
                  bio: "Raja dari semua latihan lower body. Membangun kekuatan sistemik dan stabilitas core.",
                  note: "Chest up, knee tracking mengikuti jari kaki. Turun sedalam mungkin tanpa butt wink.",
                },
              ],
            },
            {
              sets: 3,
              rest: 120,
              note: "Hip hinge - posterior chain",
              options: [
                {
                  n: "[Barbell] RDL (Barbell)",
                  t_r: "8-10",
                  t_k: 70,
                  vid: "https://www.youtube.com/watch?v=JCXUYuzwNrM",
                  bio: "Raja posterior chain. Fokus pada hip-hinge.",
                  note: "Lutut soft lock. Dorong pinggul ke belakang. Barbell menempel paha.",
                },
              ],
            },
            {
              sets: 3,
              rest: 120,
              note: "Quad isolation - knee extension",
              options: [
                {
                  n: "[Machine] Leg Extension",
                  t_r: "10-12",
                  t_k: 45,
                  vid: "https://www.youtube.com/watch?v=YyvSfVjQeL0",
                  bio: "Isolasi Rectus Femoris secara maksimal.",
                  note: "Wajib pause 1 detik di posisi kaki lurus. No momentum.",
                },
              ],
            },
            {
              sets: 3,
              rest: 90,
              note: "Hamstring isolation - knee flexion",
              options: [
                {
                  n: "[Machine] Lying Leg Curl",
                  t_r: "10-12",
                  t_k: 40,
                  vid: "https://www.youtube.com/watch?v=1Tq3QdYUuHs",
                  bio: "Pre-exhaust hamstring. Fokus pada kontraksi puncak.",
                  note: "Tekan pinggul ke pad. Kontraksi 1 detik, turun pelan 3 detik.",
                },
              ],
            },
            {
              sets: 3,
              rest: 60,
              note: "Calf isolation - ankle plantarflexion",
              options: [
                {
                  n: "[Machine] Seated Calf Raise",
                  t_r: "15-20",
                  t_k: 35,
                  vid: "https://www.youtube.com/watch?v=JbyjNymZOt0",
                  bio: "Target Soleus (otot betis dalam/lebar).",
                  note: "Full ROM. Pause di bawah untuk menghilangkan refleks regangan.",
                },
              ],
            },
          ],
        },
      };

      if (typeof EXERCISE_TARGETS !== "undefined") {
        console.log("[STARTER_PACK] Validating exercises against library...");

        let invalidCount = 0;
        Object.keys(STARTER_PACK).forEach((sessionId) => {
          const session = STARTER_PACK[sessionId];
          session.exercises.forEach((ex) => {
            ex.options.forEach((opt) => {
              if (!EXERCISE_TARGETS[opt.n]) {
                console.error(
                  `[STARTER_PACK] Invalid exercise: "${opt.n}" not in EXERCISE_TARGETS`
                );
                invalidCount++;
              }
            });
          });
        });

        if (invalidCount === 0) {
          console.log("[STARTER_PACK]  All exercises validated successfully");
        } else {
          console.error(
            `[STARTER_PACK]  ${invalidCount} invalid exercises found!`
          );
        }
      }

      // APP object is initialized in js/core.js with state and core properties
      // APP.validation is loaded from js/validation.js
      // Extending APP with additional namespaces below

      // APP.safety moved to js/safety.js

      Object.assign(APP, {
        init: function () {
          console.groupCollapsed("[APP]  Initializing The Grind Design...");
          console.time("Init Duration");

          try {
            console.log("[INIT] Starting application...");

            if (typeof dayjs !== "undefined") {
              dayjs.extend(window.dayjs_plugin_relativeTime);
              dayjs.locale("id");
            }

            if (APP.validation && APP.validation.cleanCorruptData) {
              const cleaned = APP.validation.cleanCorruptData();
              if (cleaned > 0) {
                console.log(`[INIT] Cleaned ${cleaned} corrupt entries`);
              }
            }

            const stored = LS_SAFE.getJSON("cscs_program_v10");

            console.groupCollapsed(`[INIT]  Normalizing exercise names...`);

            const normalizeReport =
              APP.validation.normalizeExerciseNames(stored);

            if (normalizeReport.normalized > 0) {
              console.log(
                ` Normalized ${normalizeReport.normalized} exercise names`
              );

              if (normalizeReport.changes.length > 0) {
                console.log("Detailed changes:");
                normalizeReport.changes.forEach((change) =>
                  console.log(`  - ${change}`)
                );
              }

              LS_SAFE.setJSON("cscs_program_v10", stored);

              try {
                console.log("Running automatic data integrity check...");
                const integrityReport = APP.data.normalizeExerciseNames();

                if (integrityReport.normalized > 0) {
                  console.warn(
                    ` Repaired ${integrityReport.normalized} fragmented exercise names`
                  );
                } else {
                  console.log("  Data integrity verified - no issues found");
                }
              } catch (e) {
                console.error(" Integrity check failed:", e);
              }

              APP.ui.showToast(
                ` Migrated ${normalizeReport.normalized} exercises. ${
                  normalizeReport.errors.length > 0
                    ? " Some issues detected."
                    : " All clear!"
                }`,
                normalizeReport.errors.length > 0 ? "warning" : "success"
              );
            }

            if (normalizeReport.errors.length > 0) {
              console.warn(" Normalization errors:");
              normalizeReport.errors.forEach((err) =>
                console.warn(`  - ${err}`)
              );
            }

            console.groupEnd();

            let validationPassed = false;

            if (stored && Object.keys(stored).length > 0) {
              if (stored && stored.spontaneous) {
                let fixed = false;

                if (!stored.spontaneous.title) {
                  stored.spontaneous.title = "Spontaneous & Mobility";
                  fixed = true;
                }
                if (!stored.spontaneous.label) {
                  stored.spontaneous.label = "SPONTANEOUS";
                  fixed = true;
                }
                if (!stored.spontaneous.dynamic) {
                  stored.spontaneous.dynamic = "Arm Circles, Jumping Jacks";
                  fixed = true;
                }
                if (!stored.spontaneous.exercises) {
                  stored.spontaneous.exercises = [];
                  fixed = true;
                }

                if (fixed) {
                  console.log(
                    "[INIT]  Auto-fixed spontaneous session structure"
                  );

                  LS_SAFE.setJSON("cscs_program_v10", stored);
                }
              }

              console.groupCollapsed(
                "[INIT]  Validating program structure..."
              );

              const validation =
                APP.validation.validateProgramStructure(stored);

              console.log(
                "Validation result:",
                validation.valid ? " PASSED" : " ISSUES DETECTED"
              );

              if (!validation.valid && validation.errors.length > 0) {
                console.warn("Errors found:");
                validation.errors.forEach((err) => console.warn(`  - ${err}`));
              }

              if (validation.warnings.length > 0) {
                console.warn("Warnings:");
                validation.warnings.forEach((warn) =>
                  console.warn(`  - ${warn}`)
                );
              }

              if (validation.valid) {
                APP.state.workoutData = stored;
                validationPassed = true;
                console.log("[INIT] Data validation passed");

                if (validation.warnings.length > 0) {
                  console.warn(
                    "[INIT] Validation warnings:",
                    validation.warnings
                  );
                }
                console.groupEnd();

                if (
                  validation.suggestions &&
                  validation.suggestions.length > 0
                ) {
                  console.log(
                    "[INIT] Exercise suggestions available:",
                    validation.suggestions
                  );
                }
              } else {
                console.error(
                  "[INIT] Data validation FAILED after normalization:",
                  validation.errors
                );

                const latestBackup = APP.safety.getLatestBackup();

                if (latestBackup) {
                  console.log(
                    "[INIT] Corrupt data detected. Latest backup found:",
                    latestBackup.id
                  );

                  const shouldRestore = confirm(
                    ` DATA VALIDATION FAILED!\n\n` +
                      `After attempting normalization, ${validation.errors.length} errors remain.\n\n` +
                      `Latest backup available:\n` +
                      `Date: ${latestBackup.date}\n` +
                      `Sessions: ${latestBackup.sessionCount}\n\n` +
                      `Restore from backup?\n\n` +
                      `(Cancel = Use Starter Pack)`
                  );

                  if (shouldRestore) {
                    const restored = APP.safety.restore(latestBackup.id);

                    if (restored) {
                      validationPassed = true;
                      console.log("[INIT] Restored from backup successfully");
                      APP.ui.showToast(
                        " Data restored from backup",
                        "success"
                      );
                    } else {
                      console.error(
                        "[INIT] Restore failed - falling back to STARTER_PACK"
                      );
                    }
                  }
                } else {
                  console.warn("[INIT] No backup available for restore");
                }
              }
            }

            if (!validationPassed) {
              console.warn(
                "[INIT] Validation issues detected - attempting graceful recovery"
              );

              APP.safety.createBackup("emergency_pre_merge");

              if (stored && Object.keys(stored).length > 0) {
                APP.state.workoutData = stored;
                APP.state.hasUnmappedExercises = true;

                console.log("[INIT] Loaded data with validation warnings");

                let unmappedCount = 0;
                Object.keys(stored).forEach((sessionId) => {
                  const session = stored[sessionId];
                  if (session.exercises) {
                    session.exercises.forEach((ex) => {
                      ex.options?.forEach((opt) => {
                        if (opt.n && !EXERCISE_TARGETS[opt.n]) {
                          unmappedCount++;
                        }
                      });
                    });
                  }
                });

                if (unmappedCount > 0) {
                  APP.ui.showToast(
                    ` ${unmappedCount} unmapped exercise(s) detected. Volume tracking may be incomplete.`,
                    "warning"
                  );
                }
              } else {
                console.log(
                  "[INIT] No stored data found - loading STARTER_PACK"
                );

                if (typeof STARTER_PACK !== "undefined") {
                  APP.state.workoutData = STARTER_PACK;
                  LS_SAFE.setJSON("cscs_program_v10", STARTER_PACK);
                  APP.ui.showToast(
                    " Welcome! Starter program loaded.",
                    "success"
                  );
                } else {
                  APP.state.workoutData = {};
                  alert(
                    " Critical Error: No data available. Please refresh page."
                  );
                }
              }
            }

            APP.safety.createBackup("app_init");
            console.log("[INIT] Init snapshot created");

            this.data.loadProfile();
            this.nav.renderDashboard();

            if (typeof Chart !== "undefined") {
              this.stats.init();
            }

            this.core.requestWakeLock();
            document.addEventListener("visibilitychange", () => {
              if (document.visibilityState === "visible") {
                this.core.requestWakeLock();
              }
            });

            try {
              const remappedLogs = APP.data.reconcileLogs();

              if (remappedLogs > 0) {
                console.log(
                  `[INIT]  Reconciled ${remappedLogs} orphaned log(s)`
                );
              }
            } catch (e) {
              console.error("[INIT]  Log reconciliation failed:", e);
            }
            console.log("[INIT] Application ready");
          } catch (e) {
            console.error("[INIT] Fatal error:", e);
            this.debug.showFatalError("App Initialization", e);
          }
          console.groupEnd();
          console.timeEnd("Init Duration");
          console.log(" Application ready");
        },

        // APP.core moved to js/core.js

        nav: {
          switchView: (v) => {
            document.getElementById("dashboard-view").classList.add("hidden");
            document.getElementById("workout-view").classList.add("hidden");
            document.getElementById(`${v}-view`).classList.remove("hidden");
            if (v === "dashboard") APP.nav.renderDashboard();
          },

          renderDashboard: () => {
            try {
              const list = document.getElementById("schedule-list");

              if (!list) {
                console.error("[DOM ERROR] schedule-list element not found");
                return;
              }

              let htmlBuffer = "";
              let oldest = Infinity;
              let recommended = "s1";
              const wData = APP.state.workoutData;
              Object.keys(wData).forEach((k) => {
                if (k === "spontaneous") return;
                const t = parseInt(LS_SAFE.get(`last_${k}`) || 0);
                if (t < oldest) {
                  oldest = t;
                  recommended = k;
                }
              });
              Object.keys(wData).forEach((k) => {
                try {
                  if (k === "spontaneous") return;

                  const d = wData[k];

                  if (!d || typeof d !== "object") {
                    console.warn(
                      `[DASHBOARD] Session ${k} has invalid structure - skipping`
                    );
                    return;
                  }

                  if (!d.title) {
                    console.warn(
                      `[DASHBOARD] Session ${k} has no title - using fallback`
                    );
                    d.title = "Untitled Session";
                  }

                  if (!d.label) {
                    d.label = "CUSTOM";
                  }

                  const last = LS_SAFE.get(`last_${k}`);
                  const timeStr = DT.formatRelative(last);
                  const isRec = k === recommended;

                  htmlBuffer += `
      <div onclick="APP.nav.loadWorkout('${k}')" class="bg-slate-800 p-4 rounded-xl border ${
                    isRec
                      ? "border-emerald-500/50 pulse-border"
                      : "border-slate-700"
                  } active:scale-95 transition flex justify-between items-center cursor-pointer mb-3 shadow-lg group relative">
        <div>
          <div class="flex items-center mb-1">
            <span class="text-[10px] font-bold text-slate-400 bg-slate-700/50 px-2 rounded">${
              d.label
            }</span>
            ${
              isRec
                ? '<span class="bg-emerald-500 text-white text-[10px] px-2 rounded ml-2 shadow">NEXT</span>'
                : ""
            }
          </div>
          <h3 class="font-bold text-white text-lg flex items-center gap-2">
            ${d.title} 
            <button 
              onclick="APP.session.openEditor(event, '${k}')" 
              class="z-10 relative p-1 text-slate-600 hover:text-emerald-400 transition"
              title="Edit Sesi Lengkap"
            >
              <i class="fa-solid fa-pen-to-square text-xs"></i>
            </button>
          </h3>
          <div class="text-xs text-slate-400 mt-1">
            <i class="fa-solid fa-clock-rotate-left mr-1"></i> ${timeStr}
          </div>
        </div>
        <div class="flex flex-col items-end gap-2">
          <div class="flex gap-1">
            <button
              onclick="APP.session.reorder('${k}', -1); event.stopPropagation();"
              class="text-slate-500 hover:text-emerald-400 px-2 py-1 text-xs bg-slate-700/50 rounded transition"
              title="Pindah ke atas"
            >
              <i class="fa-solid fa-arrow-up"></i>
            </button>
            <button
              onclick="APP.session.reorder('${k}', 1); event.stopPropagation();"
              class="text-slate-500 hover:text-emerald-400 px-2 py-1 text-xs bg-slate-700/50 rounded transition"
              title="Pindah ke bawah"
            >
              <i class="fa-solid fa-arrow-down"></i>
            </button>
            <button
              onclick="APP.session.confirmDelete(event, '${k}')"
              class="text-slate-600 hover:text-red-500 px-2 py-1 z-20 transition text-xs bg-slate-700/50 rounded"
              title="Hapus Sesi"
            >
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
          <i class="fa-solid fa-chevron-right text-slate-500"></i>
        </div>
      </div>
    `;
                } catch (e) {
                  console.error(
                    `[DASHBOARD] Failed to render session ${k}:`,
                    e
                  );
                }
              });
              list.innerHTML = htmlBuffer;
            } catch (e) {
              APP.debug.showFatalError("Render Dashboard", e);
            }
          },

          loadWorkout: (id) => {
            try {
              APP.state.currentSessionId = id;
              APP.state.focusMode = false;
              APP.ui.updateFocusBtn();

              const isSpon = id === "spontaneous";
              const badge = document.getElementById("spontaneous-badge");
              isSpon
                ? badge.classList.remove("hidden")
                : badge.classList.add("hidden");
              isSpon
                ? badge.classList.add("flex")
                : badge.classList.remove("flex");

              const data = APP.state.workoutData[id];
              if (!data) {
                alert(`Session '${id}' tidak ditemukan!`);
                APP.nav.switchView("dashboard");
                return;
              }

              if (!data.exercises || !Array.isArray(data.exercises)) {
                alert(`Data sesi corrupt! Exercises tidak valid.`);
                APP.nav.switchView("dashboard");
                return;
              }

              const wGeneral = document.getElementById("warmup-general");
              const wDynamic = document.getElementById("warmup-dynamic");
              if (wGeneral) wGeneral.innerText = "Jalan Cepat 5 Menit.";
              if (wDynamic) wDynamic.innerText = data.dynamic || "Arm Circles";

              const exList = document.getElementById("exercise-list");

              if (!exList) {
                console.error("[DOM ERROR] exercise-list element not found");
                alert("Error: Exercise list tidak ditemukan. Refresh halaman.");
                APP.nav.switchView("dashboard");
                return;
              }

              let htmlBuffer = "";

              data.exercises.forEach((ex, idx) => {
                if (ex.type === "cardio") {
                  const optIdx = LS_SAFE.get(`pref_${id}_${idx}`) || 0;
                  const opt = ex.options[optIdx] || ex.options[0];
                  const optName = opt.n || "LISS Cardio";
                  const optBio = opt.bio || "Low-intensity steady state cardio";
                  const optNote = opt.note || "Post-workout";

                  const savedMachine =
                    LS_SAFE.get(`${id}_ex${idx}_machine`) ||
                    (opt.machines ? opt.machines[0] : "Treadmill");
                  const savedDuration =
                    LS_SAFE.get(`${id}_ex${idx}_duration`) || "30";
                  const savedHR = LS_SAFE.get(`${id}_ex${idx}_hr`) || "";
                  const savedNote =
                    LS_SAFE.get(`${id}_ex${idx}_cardio_note`) || "";
                  const isCompleted =
                    LS_SAFE.get(`${id}_ex${idx}_completed`) === "true";

                  const profile = LS_SAFE.getJSON("profile", {});
                  const age = profile.a || 30;
                  const maxHR = 220 - age;
                  const zone2Lower = Math.round(maxHR * 0.6);
                  const zone2Upper = Math.round(maxHR * 0.7);

                  let hrStatus = "";
                  let hrClass = "";
                  if (savedHR) {
                    const hr = parseInt(savedHR);
                    if (hr >= zone2Lower && hr <= zone2Upper) {
                      hrStatus = ` Zone 2 (${zone2Lower}-${zone2Upper} bpm)`;
                      hrClass = "hr-zone-valid";
                    } else if (hr >= zone2Lower - 5 && hr <= zone2Upper + 5) {
                      hrStatus = ` Near Zone 2 (Target: ${zone2Lower}-${zone2Upper})`;
                      hrClass = "hr-zone-warning";
                    } else {
                      hrStatus = ` Outside Zone 2 (Target: ${zone2Lower}-${zone2Upper})`;
                      hrClass = "hr-zone-invalid";
                    }
                  }

                  const machines = opt.machines || [
                    "Treadmill",
                    "Static Bike",
                    "Rowing Machine",
                    "Elliptical",
                  ];
                  const machineOptions = machines
                    .map(
                      (m) =>
                        `<option value="${m}" ${
                          m === savedMachine ? "selected" : ""
                        }>${m}</option>`
                    )
                    .join("");

                  const quickNotes = [
                    "Felt easy",
                    "Good pace",
                    "Tough",
                    "Perfect recovery",
                  ];
                  const noteButtons = quickNotes
                    .map(
                      (n) =>
                        `<button onclick="APP.cardio.selectNote('${id}', ${idx}, '${n}')" class="quick-note-badge ${
                          savedNote === n ? "active" : ""
                        }">${n}</button>`
                    )
                    .join("");

                  htmlBuffer += `
            <div class="exercise-card cardio-card ${
              isCompleted ? "all-completed" : ""
            } bg-slate-800 rounded-xl border overflow-hidden shadow-md mb-4" id="card-${idx}">
                <div class="cardio-header p-3">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-blue-400 font-bold text-sm flex items-center gap-2">
                            <span> #${idx + 1} CARDIO</span>
                            <span class="text-xs text-slate-400 bg-slate-800 px-2 py-0.5 rounded">${optNote}</span>
                        </span>
<div class="flex items-center">
                            <button onclick="APP.data.moveCard('${id}',${idx},-1)" class="text-slate-500 hover:text-white px-2" title="Naik">
                                <i class="fa-solid fa-arrow-up text-xs"></i>
                            </button>
                            <button onclick="APP.data.moveCard('${id}',${idx},1)" class="text-slate-500 hover:text-white px-2" title="Turun">
                                <i class="fa-solid fa-arrow-down text-xs"></i>
                            </button>
                            <button onclick="APP.data.deleteCard('${id}',${idx})" class="text-red-500/50 hover:text-red-500 px-2 ml-1" title="Hapus">
                                <i class="fa-solid fa-trash text-xs"></i>
                            </button>
                        </div>
                        </div>                    <div class="text-sm font-bold text-white mb-1">${optName}</div>
                    <div class="text-xs text-slate-400">${optBio}</div>
                </div>
                
                <div class="p-4 space-y-3">
                    ${
                      isCompleted
                        ? `
                    <div class="cardio-complete-summary">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="text-4xl"></div>
                            <div>
                                <div class="text-2xl font-black text-blue-400">${savedDuration} min</div>
                                <div class="text-sm text-slate-300"> ${savedHR} bpm  ${savedMachine}</div>
                            </div>
                        </div>
                        <button onclick="APP.cardio.toggleComplete('${id}', ${idx}, false)" class="w-full bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-2 rounded-lg mt-2">
                            <i class="fa-solid fa-chevron-down mr-1"></i> Show Details
                        </button>
                    </div>
                    `
                        : `
                    <div>
                        <label class="text-xs text-slate-400 block mb-1">Equipment</label>
                        <select onchange="LS_SAFE.set('${id}_ex${idx}_machine', this.value)" class="w-full bg-slate-900 border border-slate-700 text-white text-sm rounded p-2">
                            ${machineOptions}
                        </select>
                    </div>
                    
                    <div>
                        <label class="text-xs text-slate-400 block mb-2"> Duration</label>
                        <div class="grid grid-cols-4 gap-2 mb-2">
                            ${[15, 20, 30, 45]
                              .map(
                                (min) => `
                                <button onclick="APP.cardio.setDuration('${id}', ${idx}, ${min})" class="duration-preset-btn ${
                                  savedDuration == min ? "active" : ""
                                }">${min}m</button>
                            `
                              )
                              .join("")}
                        </div>
                        <input type="number" id="duration-${id}-${idx}" value="${savedDuration}" onchange="APP.cardio.setDuration('${id}', ${idx}, this.value)" class="w-full bg-slate-900 border border-slate-700 text-white text-center rounded p-2 text-sm" placeholder="Custom minutes" />
                    </div>
                    
                    <div>
                        <label class="text-xs text-slate-400 block mb-1"> Average Heart Rate</label>
                        <input type="number" id="hr-${id}-${idx}" value="${savedHR}" oninput="APP.cardio.validateHR('${id}', ${idx}, this.value)" class="w-full bg-slate-900 border border-slate-700 text-white text-center rounded p-2 text-sm mb-1" placeholder="bpm" />
                        <div id="hr-status-${id}-${idx}" class="text-xs ${hrClass}">${
                            hrStatus ||
                            `Target: ${zone2Lower}-${zone2Upper} bpm (Zone 2)`
                          }</div>
                    </div>
                    
                    <div>
                        <label class="text-xs text-slate-400 block mb-2"> How did it feel?</label>
                        <div class="flex flex-wrap gap-2">
                            ${noteButtons}
                        </div>
                    </div>
                    
                    <button onclick="APP.cardio.toggleComplete('${id}', ${idx}, true)" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition active:scale-95">
                        <i class="fa-solid fa-check"></i> COMPLETE CARDIO
                    </button>
                    `
                    }
                </div>
            </div>`;
                  return;
                }

                if (!ex.options || ex.options.length === 0) {
                  console.warn(`[SKIP] Exercise ${idx} has no options`);
                  return;
                }

                let savedVar = parseInt(LS_SAFE.get(`pref_${id}_${idx}`) || 0);
                if (
                  isNaN(savedVar) ||
                  savedVar < 0 ||
                  savedVar >= ex.options.length
                ) {
                  console.warn(
                    `[RESET] Invalid variant ${savedVar} for exercise ${idx}, reset to 0`
                  );
                  savedVar = 0;
                  LS_SAFE.set(`pref_${id}_${idx}`, 0);
                }

                const opt = ex.options[savedVar];
                if (!opt) {
                  console.error(
                    `[CRITICAL] Option not found at index ${savedVar} for exercise ${idx}`
                  );
                  return;
                }

                const optName = opt.n || "Unknown Exercise";
                const optVid = opt.vid || "";
                const optBio = opt.bio || "No description";
                const optNote = opt.note || ex.note || "Edit Note";
                const optTargetK = opt.t_k || "-";
                const optTargetR = opt.t_r || "-";

                const _id = id;
                const _idx = idx;
                const _savedVar = savedVar;

                const vidKey = `vid_ovr_${_id}_${_idx}_${_savedVar}`;
                const vidUrl = LS_SAFE.get(vidKey) || optVid;

                let optHtml = ex.options
                  .map(
                    (o, i) =>
                      `<option value="${i}" ${
                        i == _savedVar ? "selected" : ""
                      }>${o.n || "Option " + i}</option>`
                  )
                  .join("");

                const historySuggestion = APP.data.getSuggestion(optName);

                let targetBadge = "";
                if (optTargetK !== "-" || optTargetR !== "-") {
                  targetBadge = `<div class="text-[10px] text-blue-300 bg-blue-900/30 px-2 py-0.5 rounded border border-blue-900/50 flex items-center gap-1 shadow-sm shrink-0 whitespace-nowrap"><i class="fa-solid fa-crosshairs text-blue-400"></i> Target: <b class="text-white">${optTargetK}kg</b> x <b class="text-white">${optTargetR}</b></div>`;
                }

                let setsHtml = "";
                for (let i = 1; i <= ex.sets; i++) {
                  const sid = `${_id}_ex${_idx}_s${i}`;
                  const k = LS_SAFE.get(`${sid}_k`) || "";
                  const r = LS_SAFE.get(`${sid}_r`) || "";
                  const rpe = LS_SAFE.get(`${sid}_rpe`) || "";
                  const done = LS_SAFE.get(`${sid}_d`) === "true";
                  const note = APP.data.getSetNote(_id, _idx, i);
                  let rpeColor = "text-white";
                  const rpeVal = parseFloat(rpe);
                  if (rpeVal <= 7) rpeColor = "text-yellow-400";
                  else if (rpeVal >= 8 && rpeVal <= 9)
                    rpeColor = "text-emerald-400";
                  else if (rpeVal >= 9.5) rpeColor = "text-red-400";

                  let rpeOpts = `<option value="">RPE</option>`;
                  for (let v = 6; v <= 10; v += 0.5) {
                    rpeOpts += `<option value="${v}" ${
                      rpe == v ? "selected" : ""
                    } class="${
                      v <= 7
                        ? "text-yellow-400"
                        : v >= 9.5
                        ? "text-red-400"
                        : "text-emerald-400"
                    }">${v}</option>`;
                  }

                  setsHtml += `<div class="grid grid-cols-12 gap-1 mb-1 items-center ${
                    done ? "bg-emerald-900/20 set-row-completed" : ""
                  }" id="row_${sid}">
    <div class="col-span-1 text-center relative">
        <span class="text-slate-500 text-xs font-bold">${i}</span>
        <i class="fa-solid fa-message set-note-icon ${
          note ? "has-note" : ""
        } absolute -top-1 -right-1 text-[8px]" onclick="APP.data.openSetNoteModal('${_id}',${_idx},${i})" title="${
                    note || "Add note"
                  }"></i>
    </div>                                <div class="col-span-4"><input type="number" value="${k}" class="w-full bg-slate-900 border-slate-700 text-white text-center rounded p-1.5 text-sm input-k" data-sid="${sid}" placeholder="kg" onchange="APP.data.saveSet('${sid}','k',this.value)"></div><div class="col-span-3"><input type="number" value="${r}" class="w-full bg-slate-900 border-slate-700 text-white text-center rounded p-1.5 text-sm" placeholder="10" onchange="APP.data.saveSet('${sid}','r',this.value)"></div><div class="col-span-2"><select class="w-full bg-slate-900 border-slate-700 ${rpeColor} text-[10px] rounded p-1.5 font-bold" onchange="APP.data.saveSet('${sid}','rpe',this.value)">${rpeOpts}</select></div><div class="col-span-2 flex justify-center"><input type="checkbox" class="w-5 h-5 accent-emerald-500 checkbox-done" ${
                    done ? "checked" : ""
                  } onchange="APP.data.toggleDone('${sid}',this, ${_idx})"></div></div>`;
                }

                htmlBuffer += `
            <div class="exercise-card bg-slate-800 rounded-xl border border-slate-700 overflow-hidden shadow-md mb-4 transition-all duration-300" id="card-${_idx}">
                <div class="p-3 border-b border-slate-700 bg-slate-800/50">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-emerald-500 font-bold text-sm">#${
                          _idx + 1
                        }</span>
                        <div class="flex items-center gap-2">
                            <div class="bg-slate-700/50 px-2 py-0.5 rounded text-[10px] text-slate-400 font-medium border border-slate-600"><i class="fa-solid fa-stopwatch mr-1"></i> Rest: ${
                              ex.rest
                            }s</div>
                        <button onclick="APP.data.smartAutoFill('${_id}',${_idx})" class="text-blue-400 px-2.5 py-1.5 rounded bg-blue-500/10 text-xs hover:bg-blue-500/20 transition" title="Smart Auto-Fill All Sets">
    <i class="fa-solid fa-wand-magic-sparkles"></i> Fill All
</button>
                            <button onclick="APP.data.addCustomVariant('${_id}',${_idx})" class="text-emerald-500 px-2.5 py-1.5 rounded bg-emerald-500/10 text-xs hover:bg-emerald-500/20 transition" title="Tambah alternatif"><i class="fa-solid fa-plus"></i></button>
                            ${
                              ex.options.length > 1
                                ? `<button onclick="APP.data.deleteVariant('${_id}',${_idx},document.getElementById('variant-select-${_idx}').value)" class="text-red-500 px-2.5 py-1.5 rounded bg-red-500/10 text-xs hover:bg-red-500/20 transition" title="Hapus alternatif"><i class="fa-solid fa-trash"></i></button>`
                                : ""
                            }

                        </div>
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <select id="variant-select-${_idx}" onchange="APP.data.changeVariant('${_id}',${_idx},this.value)" class="bg-slate-900 border border-slate-600 text-white text-sm rounded p-2 flex-1 font-bold truncate focus:ring-1 focus:ring-emerald-500 transition">${optHtml}</select>
                    </div>
                    <div class="grid grid-cols-2 gap-2 px-1 mb-2">
                        <div class="flex gap-1 bg-red-900/20 rounded border border-red-900/30 overflow-hidden">
                            <a href="${vidUrl}" target="_blank" class="flex-1 text-red-400 text-[10px] flex items-center justify-center py-1.5 hover:bg-red-900/40 transition truncate"><i class="fa-brands fa-youtube mr-1"></i> Watch</a>
                            <button onclick="APP.data.editVideo('${vidKey}')" class="px-2 text-red-500/70 hover:text-red-400 border-l border-red-900/30"><i class="fa-solid fa-pen text-[9px]"></i></button>
                        </div>
                        <button onclick="APP.ui.openBio('${optName.replace(
                          /'/g,
                          "\\'"
                        )}', \`${optBio.replace(
                  /`/g,
                  "\\`"
                )}\`)" class="bg-blue-900/20 text-blue-400 py-1.5 rounded text-[10px] border border-blue-900/30 flex items-center justify-center gap-1 hover:bg-blue-900/40 transition truncate"><i class="fa-solid fa-microscope"></i> Info Bio</button>
                        <button onclick="APP.ui.openHist('${optName.replace(
                          /'/g,
                          "\\'"
                        )}')" class="bg-purple-900/20 text-purple-400 py-1.5 rounded text-[10px] border border-purple-900/30 flex items-center justify-center gap-1 hover:bg-purple-900/40 transition truncate"><i class="fa-solid fa-clock-rotate-left"></i> History</button>
                        <button onclick="APP.ui.openCalc(${_idx})" class="bg-yellow-900/20 text-yellow-400 py-1.5 rounded text-[10px] border border-yellow-900/30 flex items-center justify-center gap-1 hover:bg-yellow-900/40 transition truncate"><i class="fa-solid fa-calculator"></i> WarmUp Calc</button>
                    </div>
                    <div class="flex flex-col gap-2 mb-1 px-1">
    <div onclick="APP.data.editNote('${_id}',${_idx})" class="text-[10px] text-yellow-500 font-bold cursor-pointer hover:text-white leading-relaxed break-words"><i class="fa-solid fa-pen-to-square mr-1"></i> ${optNote}</div>
    <div class="grid grid-cols-2 gap-2">
        <div class="flex flex-col gap-1">
            <div class="text-[9px] text-slate-500 font-mono">${historySuggestion}</div>
            <div id="last-volume-${_idx}" class="text-[9px] text-slate-500 font-mono"></div>
        </div>
        <div class="flex justify-end">
            ${targetBadge}
        </div>
    </div>
</div>
                </div>
<div class="p-3 sets-container">
    <div class="volume-counter" id="volume-counter-${_idx}">
        <div class="text-xs text-slate-400 text-center">Complete sets to see volume</div>
    </div>
    <div class="grid grid-cols-12 gap-1 text-[10px] text-slate-500 font-bold text-center mb-1">                        <div class="col-span-1">#</div><div class="col-span-4">KG</div><div class="col-span-3">REPS</div><div class="col-span-2">RPE</div><div class="col-span-2">OK</div>
                    </div>
                    ${setsHtml}
                </div>
                <div class="flex justify-between items-center bg-slate-900/50 p-2 border-t border-slate-700/50">
                    <div class="flex gap-2">
                        <button onclick="APP.data.modifySet('${_id}',${_idx},1)" class="text-[10px] bg-slate-700 text-emerald-400 px-2 py-1 rounded"><b>+ Set</b></button>
                        <button onclick="APP.data.modifySet('${_id}',${_idx},-1)" class="text-[10px] bg-slate-700 text-red-400 px-2 py-1 rounded"><b>- Set</b></button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="APP.data.moveCard('${_id}',${_idx},-1)" class="text-slate-500 hover:text-white px-1"><i class="fa-solid fa-arrow-up"></i></button>
                        <button onclick="APP.data.moveCard('${_id}',${_idx},1)" class="text-slate-500 hover:text-white px-1"><i class="fa-solid fa-arrow-down"></i></button>
                        <button onclick="APP.data.deleteCard('${_id}',${_idx})" class="text-red-500/50 hover:text-red-500 px-1"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>`;
              });

              exList.innerHTML = htmlBuffer;
              APP.ui.checkActiveCard();

              data.exercises.forEach((ex, idx) => {
                APP.data.updateVolumeCounter(id, idx);
              });

              APP.nav.switchView("workout");
            } catch (e) {
              APP.debug.showFatalError("Load Workout Error", e);
            }
          },
        },

        // APP.session and APP.spontaneous moved to js/session.js

        // APP.data moved to js/data.js
        // APP.ui moved to js/ui.js
        },
      });

      // APP.stats moved to js/stats.js

      APP.cardio = {
        setDuration: (sessionId, exerciseIdx, minutes) => {
          LS_SAFE.set(`${sessionId}_ex${exerciseIdx}_duration`, minutes);
          APP.nav.loadWorkout(sessionId);
        },

        validateHR: (sessionId, exerciseIdx, hr) => {
          LS_SAFE.set(`${sessionId}_ex${exerciseIdx}_hr`, hr);

          const profile = LS_SAFE.getJSON("profile", {});
          const age = profile.a || 30;
          const maxHR = 220 - age;
          const zone2Lower = Math.round(maxHR * 0.6);
          const zone2Upper = Math.round(maxHR * 0.7);

          const statusEl = document.getElementById(
            `hr-status-${sessionId}-${exerciseIdx}`
          );
          if (!statusEl) return;

          const hrVal = parseInt(hr);
          if (!hr || isNaN(hrVal)) {
            statusEl.innerHTML = `Target: ${zone2Lower}-${zone2Upper} bpm (Zone 2)`;
            statusEl.className = "text-xs text-slate-400";
            return;
          }

          if (hrVal >= zone2Lower && hrVal <= zone2Upper) {
            statusEl.innerHTML = ` Zone 2 (${zone2Lower}-${zone2Upper} bpm)`;
            statusEl.className = "text-xs hr-zone-valid";
          } else if (hrVal >= zone2Lower - 5 && hrVal <= zone2Upper + 5) {
            statusEl.innerHTML = ` Near Zone 2 (Target: ${zone2Lower}-${zone2Upper})`;
            statusEl.className = "text-xs hr-zone-warning";
          } else {
            statusEl.innerHTML = ` Outside Zone 2 (Target: ${zone2Lower}-${zone2Upper})`;
            statusEl.className = "text-xs hr-zone-invalid";
          }
        },

        selectNote: (sessionId, exerciseIdx, note) => {
          LS_SAFE.set(`${sessionId}_ex${exerciseIdx}_cardio_note`, note);
          APP.nav.loadWorkout(sessionId);
        },

        toggleComplete: (sessionId, exerciseIdx, complete) => {
          if (complete) {
            const duration = LS_SAFE.get(
              `${sessionId}_ex${exerciseIdx}_duration`
            );
            const hr = LS_SAFE.get(`${sessionId}_ex${exerciseIdx}_hr`);

            if (!duration || !hr) {
              alert("Please fill Duration and Heart Rate before completing");
              return;
            }
          }

          LS_SAFE.set(
            `${sessionId}_ex${exerciseIdx}_completed`,
            complete.toString()
          );
          APP.nav.loadWorkout(sessionId);
        },
      };

      APP.timer = {
        startTime: 0,
        start: (s) => {},
        stop: () => {},
      };

      APP.showStorageStats = () => {
        const stats = LS_SAFE.getStats();
        document.getElementById("stat-items").innerText = stats.items;
        document.getElementById("stat-size").innerText = stats.sizeKB + " KB";
        document.getElementById("stat-usage").innerText = stats.usage;

        const usagePercent = parseFloat(stats.usage);
        const bar = document.getElementById("usage-bar");
        bar.style.width = usagePercent + "%";

        if (usagePercent > 80) {
          bar.className = "bg-red-500 h-full transition-all";
        } else if (usagePercent > 50) {
          bar.className = "bg-yellow-500 h-full transition-all";
        } else {
          bar.className = "bg-emerald-500 h-full transition-all";
        }

        console.log("Storage Stats:", stats);
      };
      };

      APP.debug = {
        showFatalError: (ctx, err, extra) => {
          if (extra === undefined) extra = "";
          document.getElementById("error-modal").classList.remove("hidden");
          document.getElementById(
            "error-log-text"
          ).value = `[THE GRAND DESIGN LOG REPORT]\nCTX: ${ctx}\nERR: ${
            err.message || err
          }\n${extra}`;
        },
        copyErrorLog: () => {
          const t = document.getElementById("error-log-text");
          t.select();
          navigator.clipboard.writeText(t.value).then(() => alert("Copied!"));
        },
      };

      try {
        window.APP = APP;
      } catch (e) {
        console.warn("Could not assign window.APP", e);
      }

      if (!APP.ui) APP.ui = {};
      if (typeof APP.ui.openExercisePicker !== "function") {
        APP.ui.openExercisePicker = (mode, sessionId, exerciseIndex) => {
          alert("Exercise Picker not fully loaded. Please refresh the page.");
          console.error(
            "openExercisePicker is not properly defined. Check for parsing errors in ui object."
          );
        };
      }

      window.onload = () => APP.init();
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("sw.js")
            .then((reg) => console.log("SW Registered"))
            .catch((err) => console.log("SW Registration Failed", err));
        });
      }
    </script>
    <script>
      const CLIENT_ID =
        "803066941400-pelvk18jb4s7jsqajbic3ig6e4g2c37p.apps.googleusercontent.com";
      const SCOPES = "https://www.googleapis.com/auth/drive.appdata";
      let tokenClient;

      function gapiLoaded() {
        gapi.load("client", async () => {
          await gapi.client.init({
            discoveryDocs: [
              "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
            ],
          });
          console.log("GAPI Ready");
        });
      }

      function gsiLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: "",
        });
        console.log("GSI Ready");
      }

      function triggerManualDownload(jsonString) {
        const blob = new Blob([jsonString], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `backup_cloud_fisik_${new Date().getTime()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      async function syncToCloud() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) throw resp;
          const backupData = {};
          let itemCount = 0;
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith("gapi") || key.startsWith("google")) continue;
            backupData[key] = localStorage.getItem(key);
            itemCount++;
          }
          if (itemCount === 0) {
            if (!confirm(" Data lokal 0 item. Lanjutkan Backup?")) return;
          }
          const rawData = JSON.stringify(backupData);
          const fileName = "the-grind-design-backup.json";
          const accessToken = gapi.client.getToken().access_token;
          try {
            const search = await gapi.client.drive.files.list({
              q: `name = '${fileName}'`,
              spaces: "appDataFolder",
              fields: "files(id)",
            });
            let fileId;
            if (search.result.files.length > 0) {
              fileId = search.result.files[0].id;
              console.log("File ditemukan, ID:", fileId);
            } else {
              console.log("File tidak ada, membuat wadah baru...");
              const createRes = await fetch(
                "https://www.googleapis.com/drive/v3/files",
                {
                  method: "POST",
                  headers: {
                    Authorization: `Bearer ${accessToken}`,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    name: fileName,
                    parents: ["appDataFolder"],
                  }),
                }
              );
              const createJson = await createRes.json();
              fileId = createJson.id;
            }
            console.log("Mengupload konten ke ID:", fileId);
            const uploadRes = await fetch(
              `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`,
              {
                method: "PATCH",
                headers: {
                  Authorization: `Bearer ${accessToken}`,
                  "Content-Type": "application/json",
                },
                body: rawData,
              }
            );
            if (!uploadRes.ok)
              throw new Error(`Upload Gagal: ${uploadRes.status}`);
            alert(
              ` Backup Sukses! ${itemCount} item data diamankan di Cloud.`
            );
          } catch (err) {
            console.error("BACKUP ERROR:", err);
            alert(` Gagal Backup: ${err.message}`);
          }
        };
        tokenClient.requestAccessToken({
          prompt: "",
        });
      }
      async function restoreFromCloud() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) throw resp;
          try {
            const search = await gapi.client.drive.files.list({
              q: "name = 'the-grind-design-backup.json'",
              spaces: "appDataFolder",
            });
            if (search.result.files.length === 0) {
              alert("Tidak ada backup di Cloud.");
              return;
            }
            const fileId = search.result.files[0].id;
            if (!confirm("PERINGATAN: Data HP akan DITIMPA. Lanjutkan?"))
              return;
            const accessToken = gapi.client.getToken().access_token;
            const response = await fetch(
              `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
              {
                headers: {
                  Authorization: `Bearer ${accessToken}`,
                },
              }
            );
            const rawText = await response.text();
            if (!rawText || rawText.length < 5) {
              alert(" File Cloud Kosong (Zombie). Silakan Backup ulang.");
              return;
            }
            triggerManualDownload(rawText);
            let cloudData;
            try {
              cloudData = JSON.parse(rawText);
            } catch (e) {
              alert("Format JSON Rusak.");
              return;
            }
            if (typeof cloudData === "string") {
              try {
                cloudData = JSON.parse(cloudData);
              } catch (e) {}
            }
            localStorage.clear();
            let restoreCount = 0;
            for (const key in cloudData) {
              if (cloudData.hasOwnProperty(key)) {
                let val = cloudData[key];
                if (typeof val === "object") val = JSON.stringify(val);
                localStorage.setItem(key, val);
                restoreCount++;
              }
            }
            setTimeout(() => {
              alert(
                ` Restore Berhasil! File backup juga telah didownload ke perangkat Anda.\nAplikasi akan dimuat ulang...`
              );
              location.reload();
            }, 1000);
          } catch (err) {
            console.error("RESTORE ERROR:", err);
            alert(` Error: ${err.message}`);
          }
        };
        tokenClient.requestAccessToken({
          prompt: "",
        });
      }
      window.addEventListener("load", () => {
        gapiLoaded();
        gsiLoaded();
      });
    </script>
  </body>
</html>
