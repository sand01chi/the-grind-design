# V30.5: AI Consultation Integration - Implementation Notes

**Branch:** `v30.5-ai-consultation`  
**Commit:** `42571b4`  
**Status:** ‚úÖ Implementation Complete, Testing Pending

---

## OVERVIEW

V30.5 adds AI consultation capability to Advanced Analytics (Klinik View). Users can now click a button to auto-generate a comprehensive consultation prompt that includes:
- All clinical insights (danger/warning/info)
- Current active exercise program (spontaneous excluded)
- Structured questions in Bahasa Indonesia

The prompt is automatically loaded into the AI Command Center for immediate use.

---

## USER FLOW

```
Advanced Analytics (Klinik View)
    ‚Üì
[Clinical Insights Section]
    ‚Üì
User clicks: "Konsultasi AI Tentang Insights"
    ‚Üì
[Backend Processing]
  ‚Ä¢ Gather all insights
  ‚Ä¢ Get active program (filter spontaneous)
  ‚Ä¢ Build comprehensive prompt
  ‚Ä¢ Store in localStorage
    ‚Üì
[Navigation]
  ‚Ä¢ Auto-switch to AI View
  ‚Ä¢ Pre-fill textarea with consultation
  ‚Ä¢ Show "Auto-Consultation Active" banner
    ‚Üì
User: Copy prompt ‚Üí Paste to Gemini/ChatGPT
```

---

## TECHNICAL IMPLEMENTATION

### 1. Backend Functions (js/stats.js)

#### `prepareAnalyticsConsultation(insights)`
**Purpose:** Generate comprehensive consultation prompt from insights + program context

**Input:**
```javascript
insights = [
  {
    id: "danger_muscle_imbalance_pushpull",
    type: "danger",
    title: "Critical Push-Pull Imbalance",
    metrics: "Push: 45 sets | Pull: 12 sets (Ratio: 3.75:1)",
    risk: "High injury risk...",
    action: "Add 20+ sets of pull...",
    evidence: { source: "Schoenfeld (2016)", details: "..." }
  },
  // ... more insights
]
```

**Output Structure:**
```
=== CLINICAL INSIGHTS DETECTED ===
üö® CRITICAL ISSUES:
‚Ä¢ [Danger insight 1]
  Metrics: ...
  Risk: ...
  Action: ...
  Evidence: ...

‚ö†Ô∏è WARNINGS:
‚Ä¢ [Warning insight 1]
  ...

‚ÑπÔ∏è INFORMATIONAL:
‚Ä¢ [Info insight 1]
  ...

=== PROGRAM AKTIF SAAT INI ===
Push Day: "Heavy Chest & Shoulders"
- Total Exercises: 8
  1. Bench Press (4 sets)
  2. Overhead Press (3 sets)
  3. CARDIO: 30min @ Zone 2
  4. Cable Flys (3 sets)
  5. Lateral Raises (3 sets)
  ... +3 more exercises

Pull Day: "Back & Biceps"
- Total Exercises: 5
  ...

=== PERTANYAAN ===
1. **Analisis Prioritas:** Masalah mana yang harus ditangani PERTAMA dan mengapa?

2. **Modifikasi Program:** Exercise apa yang perlu:
   - Ditambahkan (sebutkan 3-5 exercise spesifik)
   - Dikurangi volume/frequency-nya
   - Dirotasi keluar dari program

3. **Split Training Optimal:** Berdasarkan imbalances yang ada, apakah struktur program saya (Push, Pull, Legs) sudah optimal? Atau perlu reorganisasi?

4. **Timeline Perbaikan:** Berapa lama (dalam minggu) untuk melihat improvement signifikan?

5. **Rekomendasi Exercise:** Jika perlu tambahan exercise, berikan dalam format JSON (program_import schema) yang bisa saya import langsung ke program.

---
Format response: Bahasa Indonesia, analisis evidence-based, actionable recommendations.
Prioritaskan SAFETY dan PROGRESSION yang sustainable.
```

**Key Logic:**
```javascript
// Group insights by severity
const dangers = insights.filter(i => i.type === 'danger');
const warnings = insights.filter(i => i.type === 'warning');
const infos = insights.filter(i => i.type === 'info' || i.type === 'success');

// Get active program (exclude spontaneous)
const program = window.APP.state?.workoutData || {};
const sessionIds = Object.keys(program).filter(id => id !== "spontaneous");

// Format exercises (first 5 per session)
session.exercises.slice(0, 5).map((ex, idx) => {
  if (ex.type === "cardio") {
    return `${idx + 1}. CARDIO: ${ex.target_duration}min @ ${ex.target_hr_zone}`;
  } else {
    return `${idx + 1}. ${ex.options[0].n} (${ex.sets} sets)`;
  }
});
```

---

#### `consultAIAboutInsights()`
**Purpose:** Navigation handler that triggers AI consultation flow

**Logic:**
```javascript
consultAIAboutInsights: function() {
  // 1. Get insights (use cached or recalculate)
  const insights = window.APP._currentInsights || this.interpretWorkoutData(30);
  
  // 2. Validate insights exist
  if (!insights || insights.length === 0) {
    window.APP.ui.showToast("Tidak ada insights untuk konsultasi", "warning");
    return;
  }
  
  // 3. Generate consultation prompt
  const consultationPrompt = this.prepareAnalyticsConsultation(insights);
  
  // 4. Store in localStorage (one-time autoprompt)
  localStorage.setItem('ai_autoprompt', consultationPrompt);
  localStorage.setItem('ai_autoprompt_source', 'analytics_consultation');
  localStorage.setItem('ai_autoprompt_timestamp', Date.now().toString());
  
  // 5. Navigate to AI view
  setTimeout(() => {
    window.APP.nav.switchView('ai');
  }, 300);
}
```

**Storage Keys:**
- `ai_autoprompt`: The consultation prompt text
- `ai_autoprompt_source`: Source identifier ('analytics_consultation')
- `ai_autoprompt_timestamp`: When prompt was generated

---

### 2. UI Component (js/stats.js)

**Location:** Clinical Insights section in Advanced Analytics tab

**HTML Structure:**
```html
<div class="mt-4 pt-4 border-t border-white/10">
  <button 
    onclick="window.APP.stats.consultAIAboutInsights()" 
    class="w-full px-4 py-3 rounded-xl font-semibold text-sm 
           bg-gradient-to-r from-blue-600 to-purple-600 
           hover:from-blue-500 hover:to-purple-500 
           text-white shadow-lg shadow-blue-900/50 
           transition-all duration-300 
           flex items-center justify-center gap-2
           active:scale-95">
    <i class="fas fa-brain"></i>
    <span>Konsultasi AI Tentang Insights</span>
    <i class="fas fa-arrow-right text-xs"></i>
  </button>
  <p class="text-[10px] text-app-subtext text-center mt-2">
    Auto-generate comprehensive prompt with active program context
  </p>
</div>
```

**Design Decisions:**
- **Blue-Purple Gradient:** Matches AI theme (distinct from teal analytics)
- **Brain Icon (`fa-brain`):** Clear AI association
- **Full Width Button:** Prominent CTA for easy discovery
- **Helper Text:** Explains what the button does
- **Conditional Rendering:** Only shows when `insights.length > 0`

---

### 3. AI View Integration (js/ui.js)

**Modified Function:** `renderContextMode(container)`

**Autoprompt Detection Logic:**
```javascript
renderContextMode: function(container) {
  // Check for autoprompt from analytics
  const autoprompt = localStorage.getItem('ai_autoprompt');
  const autopromptSource = localStorage.getItem('ai_autoprompt_source');
  
  let contextText = "";
  let isAutoprompt = false;
  
  if (autoprompt && autopromptSource === 'analytics_consultation') {
    // Use autoprompt
    contextText = autoprompt;
    isAutoprompt = true;
    
    // Clear localStorage (one-time use)
    localStorage.removeItem('ai_autoprompt');
    localStorage.removeItem('ai_autoprompt_source');
    localStorage.removeItem('ai_autoprompt_timestamp');
    
    console.log("[UI] Loaded autoprompt from analytics consultation");
  } else {
    // Normal context generation
    contextText = window.APP.aiBridge.getPromptContext("coach");
  }
  
  // Render with conditional banner...
}
```

**Visual Indicators:**
When autoprompt is active:
```html
<div class="bg-gradient-to-r from-blue-600/20 to-purple-600/20 
            border border-blue-500/50 rounded-xl p-3 mb-2">
  <div class="flex items-center gap-2 mb-1">
    <i class="fas fa-brain text-blue-400"></i>
    <span class="text-xs font-semibold text-blue-300">
      Auto-Consultation Active
    </span>
  </div>
  <p class="text-[10px] text-slate-400">
    Prompt generated from Advanced Analytics with clinical insights + active program context
  </p>
</div>
```

---

## INTEGRATION PATTERNS

### Pattern 1: Context Generation (from AI Command Center)
**Reference:** `APP.aiBridge.getPromptContext()`

V30.5 reuses the same context structure:
- User profile (age, weight, training experience)
- Recent workout logs (last 5 dates with [SPONTANEOUS] tags)
- Active program structure with exercise details

**Implementation:**
```javascript
// Get active program
const program = window.APP.state?.workoutData || {};
const sessionIds = Object.keys(program).filter(id => id !== "spontaneous");

// Format like getPromptContext()
sessionIds.forEach(id => {
  const session = program[id];
  prompt += `${session.label}: "${session.title}"\n`;
  prompt += `- Total Exercises: ${session.exercises?.length}\n`;
  // ... exercise details
});
```

### Pattern 2: Spontaneous Exclusion (from copyCurrentProgram)
**Reference:** `APP.ui.copyCurrentProgram()`

Both use same filter pattern:
```javascript
const sessionIds = Object.keys(workoutData).filter(id => id !== 'spontaneous');
```

**Rationale:** Spontaneous workouts are ad-hoc and not part of structured program planning.

### Pattern 3: Manual Copy (from prepareImbalanceConsultation)
**Reference:** `APP.stats.prepareImbalanceConsultation()`

V30.5 differs here:
- **Imbalance:** Uses `APP.ui.showManualCopy(promptText)` ‚Üí user copies manually
- **V30.5:** Uses localStorage autoprompt ‚Üí auto-navigates to AI view

**Why Different?**
- V30.5 integrates tightly with AI Command Center for seamless UX
- One-click flow: Analytics ‚Üí AI (no manual copy step)
- Future-proof for potential AI API integration

---

## CODE LOCATIONS

| Component | File | Lines | Description |
|-----------|------|-------|-------------|
| `prepareAnalyticsConsultation()` | js/stats.js | ~4521-4630 | Prompt generation |
| `consultAIAboutInsights()` | js/stats.js | ~4632-4660 | Navigation handler |
| Consultation Button UI | js/stats.js | ~2930-2955 | Button component |
| `renderContextMode()` (enhanced) | js/ui.js | ~1263-1330 | Autoprompt detection |

---

## TESTING CHECKLIST

### End-to-End Flow
- [ ] Navigate to Advanced Analytics (Klinik View)
- [ ] Switch to "Advanced Analytics" tab
- [ ] Verify "Konsultasi AI Tentang Insights" button appears below insights
- [ ] Click button ‚Üí should navigate to AI view
- [ ] Verify "Auto-Consultation Active" banner appears
- [ ] Verify textarea is pre-filled with consultation prompt
- [ ] Copy prompt ‚Üí paste to Gemini/ChatGPT
- [ ] Verify insights are grouped correctly (danger/warning/info)
- [ ] Verify active program context is included
- [ ] Verify spontaneous sessions are excluded

### Edge Cases
- [ ] No insights yet (new user) ‚Üí button should still appear (or show warning)
- [ ] Only spontaneous workouts ‚Üí prompt should note "Tidak ada program aktif"
- [ ] Navigate away and back to AI view ‚Üí autoprompt should be cleared
- [ ] Refresh page after autoprompt ‚Üí should show normal context (not consultation)

### UI/UX
- [ ] Button styling matches dark OLED theme
- [ ] Blue-purple gradient distinct from teal analytics theme
- [ ] Hover/active states work smoothly
- [ ] 300ms navigation delay feels natural
- [ ] Banner is visually distinct but not intrusive
- [ ] Helper text is readable and helpful

---

## KNOWN LIMITATIONS

1. **One-Time Autoprompt:**
   - Autoprompt is cleared after first use
   - Navigating back to AI view shows normal context
   - User must click button again for new consultation

2. **No AI API Integration:**
   - User must manually copy prompt to external AI (Gemini/ChatGPT)
   - Future enhancement: Direct API integration for inline chat

3. **Insights Cache:**
   - Uses `window.APP._currentInsights` if available
   - May be stale if user logs workout without refreshing analytics
   - Recalculates if cache missing

4. **Program Context Limit:**
   - Shows first 5 exercises per session
   - Long programs (>5 exercises) truncated with "... +N more"
   - Trade-off for prompt length vs. completeness

---

## FUTURE ENHANCEMENTS

### V30.6 Candidates:
- **AI Response Import:** Parse AI recommendations directly into program
- **Insight History:** Track consultation history and AI responses
- **Quick Actions:** One-click apply AI suggestions (e.g., "Add 3 pull exercises")
- **Inline Chat:** Integrate AI API for in-app consultation (no copy-paste)

### V31.0 Candidates:
- **AI Training Plan Generator:** Full program redesign based on insights
- **Progress Tracking:** Compare pre/post consultation metrics
- **Evidence Library:** Expand inline citations with full papers

---

## HANDOVER CHECKLIST

- [x] Code implementation complete
- [x] Git commit with detailed message
- [ ] End-to-end testing validated
- [ ] Edge cases tested
- [ ] Update HANDOVER_V30.md with V30.5 section
- [ ] Merge v30.5-ai-consultation ‚Üí main
- [ ] Tag release (v30.5)
- [ ] User documentation updated

---

## APPENDIX: Example Consultation Prompt

```
Saya mendapat hasil analisis dari Advanced Analytics dan butuh bantuan Anda:

=== CLINICAL INSIGHTS DETECTED ===

üö® CRITICAL ISSUES:

‚Ä¢ Critical Push-Pull Imbalance Detected
  Metrics: Push: 45 sets | Pull: 12 sets (Ratio: 3.75:1)
  Risk: Ratio >2:1 linked to shoulder impingement (Ludewig et al., 2009). High injury risk.
  Suggested Action: Add 20+ sets of pull movements (rows, pulldowns) over next 2 weeks. Consider dedicated back day.
  Evidence: Schoenfeld (2016) - Training Volume Meta-Analysis

‚ö†Ô∏è WARNINGS:

‚Ä¢ Moderate Core-Leg Imbalance
  Metrics: Core: 18 sets | Legs: 42 sets (Ratio: 0.43:1)
  Risk: Weak core limits leg performance and increases lower back strain
  Suggested Action: Add 2-3 core sessions per week (planks, anti-rotation work)
  Evidence: McGill (2010) - Core Stability Research

‚ÑπÔ∏è INFORMATIONAL:

‚Ä¢ Balanced Upper Body Quad Distribution
  Metrics: Push: 45 sets | Pull: 12 sets | Shoulder: 24 sets | Core: 18 sets

=== PROGRAM AKTIF SAAT INI ===

Push: "Heavy Chest & Shoulders"
- Total Exercises: 8
  1. Bench Press (4 sets)
  2. Overhead Press (3 sets)
  3. CARDIO: 30min @ Zone 2
  4. Cable Flys (3 sets)
  5. Lateral Raises (3 sets)
  ... +3 more exercises

Pull: "Back & Biceps"
- Total Exercises: 5
  1. Lat Pulldown (3 sets)
  2. Barbell Row (4 sets)
  3. Face Pulls (3 sets)
  4. Bicep Curls (3 sets)
  5. CARDIO: 20min @ Zone 2

Legs: "Quad Focus"
- Total Exercises: 6
  1. Squat (4 sets)
  2. Leg Press (3 sets)
  3. Leg Extension (3 sets)
  4. Walking Lunges (3 sets)
  5. Calf Raises (4 sets)
  ... +1 more exercises

=== PERTANYAAN ===

Berdasarkan insights dan program aktif di atas, saya mohon bantuan Anda untuk:

1. **Analisis Prioritas:** Masalah mana yang harus ditangani PERTAMA dan mengapa?

2. **Modifikasi Program:** Exercise apa yang perlu:
   - Ditambahkan (sebutkan 3-5 exercise spesifik)
   - Dikurangi volume/frequency-nya
   - Dirotasi keluar dari program

3. **Split Training Optimal:** Berdasarkan imbalances yang ada, apakah struktur program saya (Push, Pull, Legs) sudah optimal? Atau perlu reorganisasi?

4. **Timeline Perbaikan:** Berapa lama (dalam minggu) untuk melihat improvement signifikan?

5. **Rekomendasi Exercise:** Jika perlu tambahan exercise, berikan dalam format JSON (program_import schema) yang bisa saya import langsung ke program.

--- 
Format response: Bahasa Indonesia, analisis evidence-based, actionable recommendations.
Prioritaskan SAFETY dan PROGRESSION yang sustainable.
```

---

**END OF V30.5 IMPLEMENTATION NOTES**
